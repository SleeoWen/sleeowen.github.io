

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="æ–‡å®‡å‡½">
  <meta name="keywords" content="js,ts,web,h5">
  
    <meta name="description" content="åŸæ–‡åœ°å€ juejin.cn  å…ˆæŠŠç½ªé­ç¥¸é¦–æŒ‚åœ¨è¿™é‡Œç»™å¤§å®¶ç¾¤æ®´ ğŸ‘‡ 12345678910111213141516171819202122Promise.resolve().then(() &#x3D;&gt; &#123;    console.log(0);    return Promise.resolve(4);&#125;).then((res) &#x3D;&gt; &#123;    consol">
<meta property="og:type" content="article">
<meta property="og:title" content="ä»ä¸€é“è®©æˆ‘å¤±çœ çš„Promiseé¢è¯•é¢˜å¼€å§‹ï¼Œæ·±å…¥åˆ†æPromiseå®ç°ç»†èŠ‚">
<meta property="og:url" content="http://example.com/2021/03/31/%E4%BB%8E%E4%B8%80%E9%81%93%E8%AE%A9%E6%88%91%E5%A4%B1%E7%9C%A0%E7%9A%84Promise%E9%9D%A2%E8%AF%95%E9%A2%98%E5%BC%80%E5%A7%8B%EF%BC%8C%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90Promise%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/index.html">
<meta property="og:site_name" content="SleeoWen-Blog">
<meta property="og:description" content="åŸæ–‡åœ°å€ juejin.cn  å…ˆæŠŠç½ªé­ç¥¸é¦–æŒ‚åœ¨è¿™é‡Œç»™å¤§å®¶ç¾¤æ®´ ğŸ‘‡ 12345678910111213141516171819202122Promise.resolve().then(() &#x3D;&gt; &#123;    console.log(0);    return Promise.resolve(4);&#125;).then((res) &#x3D;&gt; &#123;    consol">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ede6d693a30f4841a51d5a7281ffc149~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2baaf009636748c491898aafeceddb32~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b6b60d615564bf892084c277f2e111b~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/535045144acb4d7794d05569b231e892~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6c62e0df759748eb97b453ff94492877~tplv-k3u1fbpfcp-watermark.image">
<meta property="article:published_time" content="2021-03-31T09:39:18.000Z">
<meta property="article:modified_time" content="2024-07-07T07:40:24.609Z">
<meta property="article:author" content="æ–‡å®‡å‡½">
<meta property="article:tag" content="Promise">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ede6d693a30f4841a51d5a7281ffc149~tplv-k3u1fbpfcp-watermark.image">
  
  
  
  <title>ä»ä¸€é“è®©æˆ‘å¤±çœ çš„Promiseé¢è¯•é¢˜å¼€å§‹ï¼Œæ·±å…¥åˆ†æPromiseå®ç°ç»†èŠ‚ - SleeoWen-Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>SleeoWen-Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ä»ä¸€é“è®©æˆ‘å¤±çœ çš„Promiseé¢è¯•é¢˜å¼€å§‹ï¼Œæ·±å…¥åˆ†æPromiseå®ç°ç»†èŠ‚"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-03-31 17:39" pubdate>
          2021å¹´3æœˆ31æ—¥ ä¸‹åˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          8.8k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          74 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">ä»ä¸€é“è®©æˆ‘å¤±çœ çš„Promiseé¢è¯•é¢˜å¼€å§‹ï¼Œæ·±å…¥åˆ†æPromiseå®ç°ç»†èŠ‚</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p> åŸæ–‡åœ°å€ <a target="_blank" rel="noopener" href="https://juejin.cn/post/6945319439772434469?utm_source=gold_browser_extension">juejin.cn</a></p>
</blockquote>
<p><strong>å…ˆæŠŠç½ªé­ç¥¸é¦–æŒ‚åœ¨è¿™é‡Œç»™å¤§å®¶ç¾¤æ®´</strong> ğŸ‘‡</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs arcade">Promise.resolve().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> Promise.resolve(<span class="hljs-number">4</span>);<br>&#125;).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(res)<br>&#125;)<br><br>Promise.resolve().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">1</span>);<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">2</span>);<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>);<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">5</span>);<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>&#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">6</span>);<br>&#125;)<br><br><span class="hljs-comment">// å¤§å®¶å…ˆæ€è€ƒä¸€ä¸‹</span><br><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>è¿™é“é¢è¯•é¢˜æ˜¯æ— æ„é—´åœ¨å¾®ä¿¡ç¾¤é‡Œçœ‹åˆ°çš„ï¼Œæ®è¯´æ˜¯æŸå‚çš„é¢è¯•é¢˜ã€‚ä¸€èˆ¬å…³äº Promise çš„é¢è¯•é¢˜æ— éæ˜¯è€ƒå¯Ÿå®å¾®ä»»åŠ¡ã€EventLoop ä¹‹ç±»çš„ï¼Œå½“æˆ‘è®¤çœŸå»åˆ†æè¿™é“é¢˜çš„æ—¶å€™ï¼Œè¶Šçœ‹è¶Šä¸å¯¹åŠ²ï¼Œæ„Ÿè§‰æœ‰è¯ˆï¼è¿™æ˜¯è¦è€ƒå¯Ÿå•¥ï¼Ÿ</p>
<p>ä¸ç®¡äº†ï¼Œå…ˆåœ¨æµè§ˆå™¨è¾“å‡ºä¸€ä¸‹çœ‹çœ‹ ğŸ¤¨</p>
<p>æ‰“å°ç»“æœï¼š<strong>0ã€1ã€2ã€3ã€4ã€5ã€6</strong> ğŸ˜±</p>
<p>è¿™é‡Œ 4 æ€ä¹ˆè·‘åˆ° 3 åé¢å»äº†ï¼Œä¸è®²æ­¦å¾·ï¼Ÿ Whyâ€¦â€¦</p>
<p>åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™é“é¢˜æœ‰ä¸¤ä¸ª <code>Promise.resolve()</code>ï¼Œç›¸å½“äºåˆ›å»ºä¸¤ä¸ª<strong>çŠ¶æ€ä¸º fulfilled çš„ Promise</strong>ã€‚</p>
<p>ç´§éšä»–ä»¬åé¢çš„ç¬¬ä¸€ä¸ª then æ–¹æ³•ä¼šäº¤æ›¿å°†å…¶æ‰§è¡Œå‡½æ•°é€å…¥<strong>å¾®ä»»åŠ¡é˜Ÿåˆ—æ’é˜Ÿæ‰§è¡Œ</strong>ï¼Œæ‰€ä»¥è¿™é‡Œçš„ 0 å’Œ 1ï¼Œå¤§å®¶éƒ½å¯ä»¥ç†è§£ï¼Œä½†æ˜¯æ¥ä¸‹æ¥æ‰§è¡Œçš„ä¸æ˜¯ <code>console.log(res)</code> è€Œæ˜¯ <code>console.log(2)</code>ã€‚</p>
<p>å¦‚æœè¯´éœ€è¦ç­‰å¾… <code>return Promise.resolve(4)</code> æ‰§è¡Œå®Œå¹¶å°†å…¶ç»“æœå’ŒçŠ¶æ€åŒæ­¥ç»™å¤–éƒ¨çš„ Promiseï¼Œé‚£ä¹ˆè¿™é‡Œåªéœ€è¦åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡å»å¤„ç†å°±åº”è¯¥å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯ 4 ä¼šåœ¨ 2 åé¢æ‰å¯¹ï¼Œä¸ºå•¥éœ€è¦<strong>åˆ›å»ºä¸¤ä¸ªå¾®ä»»åŠ¡</strong>å‘¢ï¼Ÿ ğŸ¤”</p>
<p>æƒ³äº†å¾ˆä¹…ï¼Œä¹Ÿæ‰¾å¾ˆå¤šæœ‹å‹è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼Œéƒ½æ²¡æœ‰å¾—åˆ°æœ‰è¯´æœåŠ›çš„ç»“è®ºï¼ŒçœŸæ˜¯ç™¾æ€ä¸å¾—å…¶è§£ï¼è¿™æ ·æ­»æŠ ç»†èŠ‚ï¼Œæ„Ÿè§‰æœ‰ç‚¹æµªè´¹æ—¶é—´ï¼Œæ¯•ç«Ÿè¿™ç§é¢è¯•é¢˜åœ¨ç”Ÿäº§ä¸­å¹¶ä¸ä¼šå‡ºç°ï¼Œè°ä¼šå»å†™è¿™ä¹ˆå¥‡è‘©çš„ Promise ä»£ç ï¼Œ æ”¾å¼ƒäº†ï¼Œä¸å»æƒ³äº†ã€‚</p>
<p>ç„¶è€ŒğŸ˜‚ï¼Œå½“å¤©æ™šä¸Š<del>å¤œé»‘é£é«˜</del>å¤œæ·±äººé™çš„æ—¶å€™ï¼Œè„‘æµ·é‡Œé¢ä¾ç„¶è½®æ’­è¿™é“é¢è¯•é¢˜ï¼ŒçœŸçš„å¾ˆæƒ³çŸ¥é“ Promise å†…éƒ¨åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆé€»è¾‘ï¼Œè¶Šæƒ³è¶Šç¡ä¸ç€ï½è¶Šç¡ä¸ç€è¶Šæƒ³~</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ede6d693a30f4841a51d5a7281ffc149~tplv-k3u1fbpfcp-watermark.image" srcset="/img/loading.gif" lazyload></p>
<p>æ— å¥ˆä¹‹ä¸‹ï¼Œå†³å®šå‚è€ƒ Promise A+ è§„èŒƒæ‰‹å†™ä¸€ç‰ˆ Promiseï¼Œçœ‹çœ‹èƒ½ä¸èƒ½ä»å®ç°ç»†èŠ‚ä¸­æ‰¾åˆ°è››ä¸é©¬è¿¹ã€‚ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œä¸‹é¢æˆ‘ä¼šåˆ©ç”¨ä¸åŒ ğŸŒ° æ¥ä»‹ç»æ‰‹å†™çš„ç»†èŠ‚å’Œæ€è·¯ã€‚<strong>æ–‡ç« æœ€åä¼šä¾æ®å®ç°ç»†èŠ‚æ¥æ¢è®¨è¿™é“é¢è¯•é¢˜ï¼Œæœ‰æ‰‹å†™ç»éªŒçš„å¯ä»¥ç›´æ¥è·³è¿‡æ‰‹å†™ Promise å®ç°è¿‡ç¨‹ï¼Œçœ‹æœ€åçš„ç»“è®ºã€‚</strong></p>
<h2 id="æ‰‹å†™å‰éœ€è¦å…ˆäº†è§£è¿™äº›"><a href="#æ‰‹å†™å‰éœ€è¦å…ˆäº†è§£è¿™äº›" class="headerlink" title="æ‰‹å†™å‰éœ€è¦å…ˆäº†è§£è¿™äº›"></a>æ‰‹å†™å‰éœ€è¦å…ˆäº†è§£è¿™äº›</h2><p>å¦‚æœæ„Ÿè§‰å¯¹ Promise è¿˜ä¸å¤ªç†Ÿæ‚‰çš„å°±å…ˆç§»æ­¥ <a target="_blank" rel="noopener" href="https://es6.ruanyifeng.com/#docs/promise">Promise å…¥é—¨</a>ï¼Œç¨å¾®åšä¸€ä¸‹çŸ¥è¯†é¢„ä¹ ï¼Œäº†è§£ä¸€ä¸‹ Promise çš„å¸¸è§„ç”¨æ³•ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡ï¼Ÿ</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ Js æ˜¯å•çº¿ç¨‹éƒ½ï¼Œä½†æ˜¯ä¸€äº›é«˜è€—æ—¶æ“ä½œå°±å¸¦æ¥äº†è¿›ç¨‹é˜»å¡é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJs æœ‰ä¸¤ç§ä»»åŠ¡çš„æ‰§è¡Œæ¨¡å¼ï¼š<strong>åŒæ­¥æ¨¡å¼ï¼ˆSynchronousï¼‰å’Œå¼‚æ­¥æ¨¡å¼ï¼ˆAsynchronousï¼‰</strong>ã€‚</p>
<p>åœ¨å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œåˆ›å»º<strong>å¼‚æ­¥ä»»åŠ¡ä¸»è¦åˆ†ä¸ºå®ä»»åŠ¡ä¸å¾®ä»»åŠ¡ä¸¤ç§</strong>ã€‚ES6 è§„èŒƒä¸­ï¼Œå®ä»»åŠ¡ï¼ˆMacrotaskï¼‰ ç§°ä¸º Taskï¼Œ å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰ ç§°ä¸º Jobsã€‚å®ä»»åŠ¡æ˜¯ç”±å®¿ä¸»ï¼ˆæµè§ˆå™¨ã€Nodeï¼‰å‘èµ·çš„ï¼Œè€Œå¾®ä»»åŠ¡ç”± JS è‡ªèº«å‘èµ·ã€‚</p>
<p><strong>å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡çš„å‡ ç§åˆ›å»ºæ–¹å¼</strong> ğŸ‘‡</p>
<table><thead><tr><th>å®ä»»åŠ¡ï¼ˆMacrotaskï¼‰</th><th>å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰</th></tr></thead><tbody><tr><td>setTimeout</td><td>requestAnimationFrameï¼ˆæœ‰äº‰è®®ï¼‰</td></tr><tr><td>setInterval</td><td>MutationObserverï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰</td></tr><tr><td>MessageChannel</td><td>Promise.[then/catch/finally]</td></tr><tr><td>I/Oï¼Œäº‹ä»¶é˜Ÿåˆ—</td><td>process.nextTickï¼ˆNode ç¯å¢ƒï¼‰</td></tr><tr><td>setImmediateï¼ˆNode ç¯å¢ƒï¼‰</td><td>queueMicrotask</td></tr><tr><td>scriptï¼ˆæ•´ä½“ä»£ç å—ï¼‰</td><td></td></tr></tbody></table>

<p><strong>å¦‚ä½•ç†è§£ scriptï¼ˆæ•´ä½“ä»£ç å—ï¼‰æ˜¯ä¸ªå®ä»»åŠ¡å‘¢</strong> ğŸ¤”</p>
<p>å®é™…ä¸Šå¦‚æœåŒæ—¶å­˜åœ¨ä¸¤ä¸ª script ä»£ç å—ï¼Œä¼šé¦–å…ˆåœ¨æ‰§è¡Œç¬¬ä¸€ä¸ª script ä»£ç å—ä¸­çš„åŒæ­¥ä»£ç ï¼Œå¦‚æœè¿™ä¸ªè¿‡ç¨‹ä¸­åˆ›å»ºäº†å¾®ä»»åŠ¡å¹¶è¿›å…¥äº†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç¬¬ä¸€ä¸ª script åŒæ­¥ä»£ç æ‰§è¡Œå®Œä¹‹åï¼Œä¼šé¦–å…ˆå»æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå†å»å¼€å¯ç¬¬äºŒä¸ª script ä»£ç å—çš„æ‰§è¡Œã€‚æ‰€ä»¥è¿™é‡Œåº”è¯¥å°±å¯ä»¥ç†è§£ scriptï¼ˆæ•´ä½“ä»£ç å—ï¼‰ä¸ºä»€ä¹ˆä¼šæ˜¯å®ä»»åŠ¡ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯-EventLoop-ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-EventLoop-ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ EventLoop ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ EventLoop ï¼Ÿ</h3><p>å…ˆæ¥çœ‹ä¸ªå›¾</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2baaf009636748c491898aafeceddb32~tplv-k3u1fbpfcp-watermark.image" srcset="/img/loading.gif" lazyload></p>
<ol>
<li><p>åˆ¤æ–­å®ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</p>
<ul>
<li>ä¸ç©º â€“&gt; æ‰§è¡Œæœ€æ—©è¿›å…¥é˜Ÿåˆ—çš„ä»»åŠ¡ â€“&gt; æ‰§è¡Œä¸‹ä¸€æ­¥</li>
<li>ç©º â€“&gt; æ‰§è¡Œä¸‹ä¸€æ­¥</li>
</ul>
</li>
<li><p>åˆ¤æ–­å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</p>
<ul>
<li>ä¸ç©º â€“&gt; æ‰§è¡Œæœ€æ—©è¿›å…¥é˜Ÿåˆ—çš„ä»»åŠ¡ â€“&gt; <strong>ç»§ç»­æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ç©ºä¸ç©º</strong></li>
<li>ç©º â€“&gt; æ‰§è¡Œä¸‹ä¸€æ­¥</li>
</ul>
</li>
</ol>
<p>å› ä¸ºé¦–æ¬¡æ‰§è¡Œå®é˜Ÿåˆ—ä¸­ä¼šæœ‰ scriptï¼ˆæ•´ä½“ä»£ç å—ï¼‰ä»»åŠ¡ï¼Œæ‰€ä»¥å®é™…ä¸Šå°±æ˜¯ Js è§£æå®Œæˆåï¼Œåœ¨å¼‚æ­¥ä»»åŠ¡ä¸­ï¼Œä¼šå…ˆæ‰§è¡Œå®Œæ‰€æœ‰çš„å¾®ä»»åŠ¡ï¼Œè¿™é‡Œä¹Ÿæ˜¯å¾ˆå¤šé¢è¯•é¢˜å–œæ¬¢è€ƒå¯Ÿçš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ–°åˆ›å»ºçš„å¾®ä»»åŠ¡ä¼šç«‹å³è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—æ’é˜Ÿæ‰§è¡Œï¼Œä¸éœ€è¦ç­‰å¾…ä¸‹ä¸€æ¬¡è½®å›ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯-Promise-A-è§„èŒƒï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-Promise-A-è§„èŒƒï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ Promise A+ è§„èŒƒï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ Promise A+ è§„èŒƒï¼Ÿ</h3><p>çœ‹åˆ° A+ è‚¯å®šä¼šæƒ³åˆ°æ˜¯ä¸æ˜¯è¿˜æœ‰ Aï¼Œäº‹å®ä¸Šç¡®å®æœ‰ã€‚å…¶å® Promise æœ‰å¤šç§è§„èŒƒï¼Œé™¤äº†å‰é¢çš„ Promise Aã€promise A+ è¿˜æœ‰ Promise&#x2F;Bï¼ŒPromise&#x2F;Dã€‚<strong>ç›®å‰æˆ‘ä»¬ä½¿ç”¨çš„ Promise æ˜¯åŸºäº Promise A+ è§„èŒƒå®ç°çš„</strong>ï¼Œæ„Ÿå…´è¶£çš„ç§»æ­¥ <a target="_blank" rel="noopener" href="https://promisesaplus.com/">Promise A + è§„èŒƒ</a>äº†è§£ä¸€ä¸‹ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚</p>
<p>æ£€éªŒä¸€ä»½æ‰‹å†™ Promise é ä¸é è°±ï¼Œé€šè¿‡ Promise A+ è§„èŒƒè‡ªç„¶æ˜¯åŸºæœ¬è¦æ±‚ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/promises-aplus-tests">promises-aplus-tests</a> æ¥æ£€æµ‹æˆ‘ä»¬çš„ä»£ç æ˜¯å¦ç¬¦åˆè§„èŒƒï¼Œåé¢æˆ‘ä¼šè®²åˆ°å¦‚ä½•ä½¿ç”¨å®ƒã€‚</p>
<h2 id="æ‰‹å†™å¼€å§‹"><a href="#æ‰‹å†™å¼€å§‹" class="headerlink" title="æ‰‹å†™å¼€å§‹"></a>æ‰‹å†™å¼€å§‹</h2><p>å¾ˆå¤šæ‰‹å†™ç‰ˆæœ¬éƒ½æ˜¯ä½¿ç”¨ setTimeout å»åšå¼‚æ­¥å¤„ç†ï¼Œä½†æ˜¯ setTimeout å±äºå®ä»»åŠ¡ï¼Œè¿™ä¸ Promise æ˜¯ä¸ªå¾®ä»»åŠ¡ç›¸çŸ›ç›¾ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—é€‰æ‹©ä¸€ç§åˆ›å»ºå¾®ä»»åŠ¡çš„æ–¹å¼å»å®ç°æˆ‘ä»¬çš„æ‰‹å†™ä»£ç ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æœ‰å‡ ç§é€‰æ‹©ï¼Œä¸€ç§å°±æ˜¯ Promise A+ è§„èŒƒä¸­ä¹Ÿæåˆ°çš„ï¼Œprocess.nextTickï¼ˆ Node ç«¯ ï¼‰ ä¸ MutationObserverï¼ˆ æµè§ˆå™¨ç«¯ ï¼‰ï¼Œè€ƒè™‘åˆ°åˆ©ç”¨è¿™ä¸¤ç§æ–¹å¼éœ€è¦åšç¯å¢ƒåˆ¤æ–­ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å°±æ¨èå¦å¤–ä¸€ç§åˆ›å»ºå¾®ä»»åŠ¡çš„æ–¹å¼ <code>queueMicrotask</code>ï¼Œäº†è§£æ›´å¤š â€“&gt; <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide">åœ¨ JavaScript ä¸­é€šè¿‡ queueMicrotask() ä½¿ç”¨å¾®ä»»åŠ¡</a>;</p>
<h3 id="ä¸€ã€Promise-æ ¸å¿ƒé€»è¾‘å®ç°"><a href="#ä¸€ã€Promise-æ ¸å¿ƒé€»è¾‘å®ç°" class="headerlink" title="ä¸€ã€Promise æ ¸å¿ƒé€»è¾‘å®ç°"></a>ä¸€ã€Promise æ ¸å¿ƒé€»è¾‘å®ç°</h3><p>æˆ‘ä»¬å…ˆç®€å•å®ç°ä¸€ä¸‹ Promise çš„åŸºç¡€åŠŸèƒ½ã€‚å…ˆçœ‹åŸç”Ÿ Promise å®ç°çš„ ğŸŒ°ï¼Œç¬¬ä¸€æ­¥æˆ‘ä»¬è¦å®Œæˆç›¸åŒçš„åŠŸèƒ½ã€‚</p>
<p>åŸç”ŸğŸŒ° ğŸ‘‡</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arcade">const promise = <span class="hljs-keyword">new</span> Promise(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>   resolve(<span class="hljs-string">&#x27;success&#x27;</span>)<br>   reject(<span class="hljs-string">&#x27;err&#x27;</span>)<br>&#125;)<br><br>promise.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>&#125;, reason =&gt; &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;reject&#x27;</span>, reason)<br>&#125;)<br><br><span class="hljs-comment">// è¾“å‡º resolve success</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹<strong>åŸºæœ¬åŸç†</strong>ï¼š</p>
<blockquote>
<ol>
<li>Promise æ˜¯ä¸€ä¸ªç±»ï¼Œåœ¨æ‰§è¡Œè¿™ä¸ªç±»çš„æ—¶å€™ä¼šä¼ å…¥ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿™ä¸ªæ‰§è¡Œå™¨ä¼šç«‹å³æ‰§è¡Œ</li>
<li>Promise ä¼šæœ‰ä¸‰ç§çŠ¶æ€<ul>
<li>Pending ç­‰å¾…</li>
<li>Fulfilled å®Œæˆ</li>
<li>Rejected å¤±è´¥</li>
</ul>
</li>
<li>çŠ¶æ€åªèƒ½ç”± Pending â€“&gt; Fulfilled æˆ–è€… Pending â€“&gt; Rejectedï¼Œä¸”ä¸€ä½†å‘ç”Ÿæ”¹å˜ä¾¿ä¸å¯äºŒæ¬¡ä¿®æ”¹ï¼›</li>
<li>Promise ä¸­ä½¿ç”¨ resolve å’Œ reject ä¸¤ä¸ªå‡½æ•°æ¥æ›´æ”¹çŠ¶æ€ï¼›</li>
<li>then æ–¹æ³•å†…éƒ¨åšä½†äº‹æƒ…å°±æ˜¯çŠ¶æ€åˆ¤æ–­<ul>
<li>å¦‚æœçŠ¶æ€æ˜¯æˆåŠŸï¼Œè°ƒç”¨æˆåŠŸå›è°ƒå‡½æ•°</li>
<li>å¦‚æœçŠ¶æ€æ˜¯å¤±è´¥ï¼Œè°ƒç”¨å¤±è´¥å›è°ƒå‡½æ•°</li>
</ul>
</li>
</ol>
</blockquote>
<p><strong>ä¸‹é¢å¼€å§‹å®ç°</strong>ï¼š</p>
<h4 id="1-æ–°å»º-MyPromise-ç±»ï¼Œä¼ å…¥æ‰§è¡Œå™¨-executor"><a href="#1-æ–°å»º-MyPromise-ç±»ï¼Œä¼ å…¥æ‰§è¡Œå™¨-executor" class="headerlink" title="1. æ–°å»º MyPromise ç±»ï¼Œä¼ å…¥æ‰§è¡Œå™¨ executor"></a>1. æ–°å»º MyPromise ç±»ï¼Œä¼ å…¥æ‰§è¡Œå™¨ executor</h4><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-comment">// æ–°å»º MyPromise.js</span><br><br><span class="hljs-comment">// æ–°å»º MyPromise ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>)&#123;<br>    <span class="hljs-comment">// executor æ˜¯ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿›å…¥ä¼šç«‹å³æ‰§è¡Œ</span><br>    <span class="hljs-title function_">executor</span>() <br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h4 id="2-executor-ä¼ å…¥-resolve-å’Œ-reject-æ–¹æ³•"><a href="#2-executor-ä¼ å…¥-resolve-å’Œ-reject-æ–¹æ³•" class="headerlink" title="2. executor ä¼ å…¥ resolve å’Œ reject æ–¹æ³•"></a>2. executor ä¼ å…¥ resolve å’Œ reject æ–¹æ³•</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-comment">// æ–°å»º MyPromise ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>)&#123;<br>    <span class="hljs-comment">// executor æ˜¯ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿›å…¥ä¼šç«‹å³æ‰§è¡Œ</span><br>    <span class="hljs-comment">// å¹¶ä¼ å…¥resolveå’Œrejectæ–¹æ³•</span><br>    <span class="hljs-title function_">executor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">resolve</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">reject</span>) <br>  &#125;<br>  <span class="hljs-comment">// resolveå’Œrejectä¸ºä»€ä¹ˆè¦ç”¨ç®­å¤´å‡½æ•°ï¼Ÿ</span><br>  <span class="hljs-comment">// å¦‚æœç›´æ¥è°ƒç”¨çš„è¯ï¼Œæ™®é€šå‡½æ•°thisæŒ‡å‘çš„æ˜¯windowæˆ–è€…undefined</span><br>  <span class="hljs-comment">// ç”¨ç®­å¤´å‡½æ•°å°±å¯ä»¥è®©thisæŒ‡å‘å½“å‰å®ä¾‹å¯¹è±¡</span><br>  <span class="hljs-comment">// æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€</span><br>  resolve = <span class="hljs-function">() =&gt;</span> &#123;&#125;<br>  <span class="hljs-comment">// æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€</span><br>  reject = <span class="hljs-function">() =&gt;</span> &#123;&#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h4 id="3-çŠ¶æ€ä¸ç»“æœçš„ç®¡ç†"><a href="#3-çŠ¶æ€ä¸ç»“æœçš„ç®¡ç†" class="headerlink" title="3. çŠ¶æ€ä¸ç»“æœçš„ç®¡ç†"></a>3. çŠ¶æ€ä¸ç»“æœçš„ç®¡ç†</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-comment">// å…ˆå®šä¹‰ä¸‰ä¸ªå¸¸é‡è¡¨ç¤ºçŠ¶æ€</span><br><span class="hljs-keyword">const</span> PENDING = <span class="hljs-string">&#x27;pending&#x27;</span>;<br><span class="hljs-keyword">const</span> FULFILLED = <span class="hljs-string">&#x27;fulfilled&#x27;</span>;<br><span class="hljs-keyword">const</span> REJECTED = <span class="hljs-string">&#x27;rejected&#x27;</span>;<br><br><span class="hljs-comment">// æ–°å»º MyPromise ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> &#123;<br>  <span class="hljs-keyword">constructor</span>(executor)&#123;<br>    <span class="hljs-comment">// executor æ˜¯ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿›å…¥ä¼šç«‹å³æ‰§è¡Œ</span><br>    <span class="hljs-comment">// å¹¶ä¼ å…¥resolveå’Œrejectæ–¹æ³•</span><br>    executor(<span class="hljs-keyword">this</span>.resolve, <span class="hljs-keyword">this</span>.reject)<br>  &#125;<br><br>  <span class="hljs-comment">// å‚¨å­˜çŠ¶æ€çš„å˜é‡ï¼Œåˆå§‹å€¼æ˜¯ pending</span><br>  status = PENDING;<br><br>  <span class="hljs-comment">// resolveå’Œrejectä¸ºä»€ä¹ˆè¦ç”¨ç®­å¤´å‡½æ•°ï¼Ÿ</span><br>  <span class="hljs-comment">// å¦‚æœç›´æ¥è°ƒç”¨çš„è¯ï¼Œæ™®é€šå‡½æ•°thisæŒ‡å‘çš„æ˜¯windowæˆ–è€…undefined</span><br>  <span class="hljs-comment">// ç”¨ç®­å¤´å‡½æ•°å°±å¯ä»¥è®©thisæŒ‡å‘å½“å‰å®ä¾‹å¯¹è±¡</span><br>  <span class="hljs-comment">// æˆåŠŸä¹‹åçš„å€¼</span><br>  value = <span class="hljs-literal">null</span>;<br>  <span class="hljs-comment">// å¤±è´¥ä¹‹åçš„åŸå› </span><br>  reason = <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-comment">// æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€</span><br>  resolve = (value) =&gt; &#123;<br>    <span class="hljs-comment">// åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>      <span class="hljs-comment">// çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ</span><br>      <span class="hljs-keyword">this</span>.status = FULFILLED;<br>      <span class="hljs-comment">// ä¿å­˜æˆåŠŸä¹‹åçš„å€¼</span><br>      <span class="hljs-keyword">this</span>.value = value;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€</span><br>  reject = (reason) =&gt; &#123;<br>    <span class="hljs-comment">// åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>      <span class="hljs-comment">// çŠ¶æ€æˆåŠŸä¸ºå¤±è´¥</span><br>      <span class="hljs-keyword">this</span>.status = REJECTED;<br>      <span class="hljs-comment">// ä¿å­˜å¤±è´¥åçš„åŸå› </span><br>      <span class="hljs-keyword">this</span>.reason = reason;<br>    &#125;<br>  &#125;<br>&#125;<br><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h4 id="4-then-çš„ç®€å•å®ç°"><a href="#4-then-çš„ç®€å•å®ç°" class="headerlink" title="4. then çš„ç®€å•å®ç°"></a>4. then çš„ç®€å•å®ç°</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br>then(onFulfilled, onRejected) &#123;<br>  <span class="hljs-comment">// åˆ¤æ–­çŠ¶æ€</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === FULFILLED) &#123;<br>    <span class="hljs-comment">// è°ƒç”¨æˆåŠŸå›è°ƒï¼Œå¹¶ä¸”æŠŠå€¼è¿”å›</span><br>    onFulfilled(<span class="hljs-keyword">this</span>.value);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === REJECTED) &#123;<br>    <span class="hljs-comment">// è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›</span><br>    onRejected(<span class="hljs-keyword">this</span>.reason);<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h4 id="5-ä½¿ç”¨-module-exports-å¯¹å¤–æš´éœ²-MyPromise-ç±»"><a href="#5-ä½¿ç”¨-module-exports-å¯¹å¤–æš´éœ²-MyPromise-ç±»" class="headerlink" title="5. ä½¿ç”¨ module.exports å¯¹å¤–æš´éœ² MyPromise ç±»"></a>5. ä½¿ç”¨ module.exports å¯¹å¤–æš´éœ² MyPromise ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// MyPromise.js</span><br><span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = MyPromise;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>çœ‹ä¸€ä¸‹æˆ‘ä»¬ç›®å‰å®ç°çš„<strong>å®Œæ•´ä»£ç </strong>ğŸ¥³</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-comment">// å…ˆå®šä¹‰ä¸‰ä¸ªå¸¸é‡è¡¨ç¤ºçŠ¶æ€</span><br><span class="hljs-keyword">const</span> PENDING = <span class="hljs-string">&#x27;pending&#x27;</span>;<br><span class="hljs-keyword">const</span> FULFILLED = <span class="hljs-string">&#x27;fulfilled&#x27;</span>;<br><span class="hljs-keyword">const</span> REJECTED = <span class="hljs-string">&#x27;rejected&#x27;</span>;<br><br><span class="hljs-comment">// æ–°å»º MyPromise ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> &#123;<br>  <span class="hljs-keyword">constructor</span>(executor)&#123;<br>    <span class="hljs-comment">// executor æ˜¯ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿›å…¥ä¼šç«‹å³æ‰§è¡Œ</span><br>    <span class="hljs-comment">// å¹¶ä¼ å…¥resolveå’Œrejectæ–¹æ³•</span><br>    executor(<span class="hljs-keyword">this</span>.resolve, <span class="hljs-keyword">this</span>.reject)<br>  &#125;<br><br>  <span class="hljs-comment">// å‚¨å­˜çŠ¶æ€çš„å˜é‡ï¼Œåˆå§‹å€¼æ˜¯ pending</span><br>  status = PENDING;<br><br>  <span class="hljs-comment">// resolveå’Œrejectä¸ºä»€ä¹ˆè¦ç”¨ç®­å¤´å‡½æ•°ï¼Ÿ</span><br>  <span class="hljs-comment">// å¦‚æœç›´æ¥è°ƒç”¨çš„è¯ï¼Œæ™®é€šå‡½æ•°thisæŒ‡å‘çš„æ˜¯windowæˆ–è€…undefined</span><br>  <span class="hljs-comment">// ç”¨ç®­å¤´å‡½æ•°å°±å¯ä»¥è®©thisæŒ‡å‘å½“å‰å®ä¾‹å¯¹è±¡</span><br>  <span class="hljs-comment">// æˆåŠŸä¹‹åçš„å€¼</span><br>  value = <span class="hljs-literal">null</span>;<br>  <span class="hljs-comment">// å¤±è´¥ä¹‹åçš„åŸå› </span><br>  reason = <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-comment">// æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€</span><br>  resolve = (value) =&gt; &#123;<br>    <span class="hljs-comment">// åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>      <span class="hljs-comment">// çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ</span><br>      <span class="hljs-keyword">this</span>.status = FULFILLED;<br>      <span class="hljs-comment">// ä¿å­˜æˆåŠŸä¹‹åçš„å€¼</span><br>      <span class="hljs-keyword">this</span>.value = value;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€</span><br>  reject = (reason) =&gt; &#123;<br>    <span class="hljs-comment">// åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>      <span class="hljs-comment">// çŠ¶æ€æˆåŠŸä¸ºå¤±è´¥</span><br>      <span class="hljs-keyword">this</span>.status = REJECTED;<br>      <span class="hljs-comment">// ä¿å­˜å¤±è´¥åçš„åŸå› </span><br>      <span class="hljs-keyword">this</span>.reason = reason;<br>    &#125;<br>  &#125;<br><br>  then(onFulfilled, onRejected) &#123;<br>    <span class="hljs-comment">// åˆ¤æ–­çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === FULFILLED) &#123;<br>      <span class="hljs-comment">// è°ƒç”¨æˆåŠŸå›è°ƒï¼Œå¹¶ä¸”æŠŠå€¼è¿”å›</span><br>      onFulfilled(<span class="hljs-keyword">this</span>.value);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === REJECTED) &#123;<br>      <span class="hljs-comment">// è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›</span><br>      onRejected(<span class="hljs-keyword">this</span>.reason);<br>    &#125;<br>  &#125;<br>&#125;<br><br>module.exports = MyPromise<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>ä½¿ç”¨æˆ‘çš„æ‰‹å†™ä»£ç æ‰§è¡Œä¸€ä¸‹ä¸Šé¢é‚£ä¸ªğŸŒ°</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// æ–°å»º test.js</span><br><br><span class="hljs-comment">// å¼•å…¥æˆ‘ä»¬çš„ MyPromise.js</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyPromise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>   <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;success&#x27;</span>)<br>   <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;err&#x27;</span>)<br>&#125;)<br><br>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;reject&#x27;</span>, reason)<br>&#125;)<br><br><span class="hljs-comment">// æ‰§è¡Œç»“æœï¼šresolve success</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œç¬¬ä¸€æ­¥å®Œæˆäº†ğŸ‘ğŸ‘ğŸ‘</p>
<h3 id="äºŒã€åœ¨-Promise-ç±»ä¸­åŠ å…¥å¼‚æ­¥é€»è¾‘"><a href="#äºŒã€åœ¨-Promise-ç±»ä¸­åŠ å…¥å¼‚æ­¥é€»è¾‘" class="headerlink" title="äºŒã€åœ¨ Promise ç±»ä¸­åŠ å…¥å¼‚æ­¥é€»è¾‘"></a>äºŒã€åœ¨ Promise ç±»ä¸­åŠ å…¥å¼‚æ­¥é€»è¾‘</h3><p>ä¸Šé¢è¿˜æ²¡æœ‰ç»è¿‡å¼‚æ­¥å¤„ç†ï¼Œå¦‚æœæœ‰å¼‚æ­¥é€»è¾‘åŠ å¦‚æ¥ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// test.js</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyPromise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;success&#x27;</span>)<br>  &#125;, <span class="hljs-number">2000</span>); <br>&#125;)<br><br>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;reject&#x27;</span>, reason)<br>&#125;)<br><br><span class="hljs-comment">// æ²¡æœ‰æ‰“å°ä¿¡æ¯ï¼ï¼ï¼</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p><strong>åˆ†æåŸå› </strong>ï¼š</p>
<blockquote>
<p>ä¸»çº¿ç¨‹ä»£ç ç«‹å³æ‰§è¡Œï¼ŒsetTimeout æ˜¯å¼‚æ­¥ä»£ç ï¼Œthen ä¼šé©¬ä¸Šæ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™åˆ¤æ–­ Promise çŠ¶æ€ï¼ŒçŠ¶æ€æ˜¯ Pendingï¼Œç„¶è€Œä¹‹å‰å¹¶æ²¡æœ‰åˆ¤æ–­ç­‰å¾…è¿™ä¸ªçŠ¶æ€</p>
</blockquote>
<p>è¿™é‡Œå°±éœ€è¦æˆ‘ä»¬å¤„ç†ä¸€ä¸‹ Pending çŠ¶æ€ï¼Œæˆ‘ä»¬æ”¹é€ ä¸€ä¸‹ä¹‹å‰çš„ä»£ç  ğŸ¤”</p>
<h4 id="1-ç¼“å­˜æˆåŠŸä¸å¤±è´¥å›è°ƒ"><a href="#1-ç¼“å­˜æˆåŠŸä¸å¤±è´¥å›è°ƒ" class="headerlink" title="1. ç¼“å­˜æˆåŠŸä¸å¤±è´¥å›è°ƒ"></a>1. ç¼“å­˜æˆåŠŸä¸å¤±è´¥å›è°ƒ</h4><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-comment">// MyPromise ç±»ä¸­æ–°å¢</span><br><span class="hljs-comment">// å­˜å‚¨æˆåŠŸå›è°ƒå‡½æ•°</span><br>onFulfilledCallback <span class="hljs-punctuation">=</span> <span class="hljs-literal">null</span><span class="hljs-punctuation">;</span><br><span class="hljs-comment">// å­˜å‚¨å¤±è´¥å›è°ƒå‡½æ•°</span><br>onRejectedCallback <span class="hljs-punctuation">=</span> <span class="hljs-literal">null</span><span class="hljs-punctuation">;</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h4 id="2-then-æ–¹æ³•ä¸­çš„-Pending-çš„å¤„ç†"><a href="#2-then-æ–¹æ³•ä¸­çš„-Pending-çš„å¤„ç†" class="headerlink" title="2. then æ–¹æ³•ä¸­çš„ Pending çš„å¤„ç†"></a>2. then æ–¹æ³•ä¸­çš„ Pending çš„å¤„ç†</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br>then(onFulfilled, onRejected) &#123;<br>  <span class="hljs-comment">// åˆ¤æ–­çŠ¶æ€</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === FULFILLED) &#123;<br>    <span class="hljs-comment">// è°ƒç”¨æˆåŠŸå›è°ƒï¼Œå¹¶ä¸”æŠŠå€¼è¿”å›</span><br>    onFulfilled(<span class="hljs-keyword">this</span>.value);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === REJECTED) &#123;<br>    <span class="hljs-comment">// è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›</span><br>    onRejected(<span class="hljs-keyword">this</span>.reason);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>    <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>    <span class="hljs-comment">// å› ä¸ºä¸çŸ¥é“åé¢çŠ¶æ€çš„å˜åŒ–æƒ…å†µï¼Œæ‰€ä»¥å°†æˆåŠŸå›è°ƒå’Œå¤±è´¥å›è°ƒå­˜å‚¨èµ·æ¥</span><br>    <span class="hljs-comment">// ç­‰åˆ°æ‰§è¡ŒæˆåŠŸå¤±è´¥å‡½æ•°çš„æ—¶å€™å†ä¼ é€’</span><br>    <span class="hljs-keyword">this</span>.onFulfilledCallback = onFulfilled;<br>    <span class="hljs-keyword">this</span>.onRejectedCallback = onRejected;<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h4 id="3-resolve-ä¸-reject-ä¸­è°ƒç”¨å›è°ƒå‡½æ•°"><a href="#3-resolve-ä¸-reject-ä¸­è°ƒç”¨å›è°ƒå‡½æ•°" class="headerlink" title="3. resolve ä¸ reject ä¸­è°ƒç”¨å›è°ƒå‡½æ•°"></a>3. resolve ä¸ reject ä¸­è°ƒç”¨å›è°ƒå‡½æ•°</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-comment">// æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€</span><br>resolve = (value) =&gt; &#123;<br>  <span class="hljs-comment">// åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>    <span class="hljs-comment">// çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ</span><br>    <span class="hljs-keyword">this</span>.status = FULFILLED;<br>    <span class="hljs-comment">// ä¿å­˜æˆåŠŸä¹‹åçš„å€¼</span><br>    <span class="hljs-keyword">this</span>.value = value;<br>    <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>    <span class="hljs-comment">// åˆ¤æ–­æˆåŠŸå›è°ƒæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è°ƒç”¨</span><br>    <span class="hljs-keyword">this</span>.onFulfilledCallback &amp;&amp; <span class="hljs-keyword">this</span>.onFulfilledCallback(value);<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><span class="hljs-comment">// æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€</span><br>reject = (reason) =&gt; &#123;<br>  <span class="hljs-comment">// åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>    <span class="hljs-comment">// çŠ¶æ€æˆåŠŸä¸ºå¤±è´¥</span><br>    <span class="hljs-keyword">this</span>.status = REJECTED;<br>    <span class="hljs-comment">// ä¿å­˜å¤±è´¥åçš„åŸå› </span><br>    <span class="hljs-keyword">this</span>.reason = reason;<br>    <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>    <span class="hljs-comment">// åˆ¤æ–­å¤±è´¥å›è°ƒæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è°ƒç”¨</span><br>    <span class="hljs-keyword">this</span>.onRejectedCallback &amp;&amp; <span class="hljs-keyword">this</span>.onRejectedCallback(reason)<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†æ‰§è¡Œä¸€ä¸‹ä¸Šé¢çš„ğŸŒ°</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// test.js</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyPromise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;success&#x27;</span>)<br>  &#125;, <span class="hljs-number">2000</span>); <br>&#125;)<br><br>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;reject&#x27;</span>, reason)<br>&#125;)<br><br><span class="hljs-comment">// ç­‰å¾… 2s è¾“å‡º resolve success</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>ç›®å‰å·²ç»å¯ä»¥ç®€å•å¤„ç†å¼‚æ­¥é—®é¢˜äº†âœŒï¸</p>
<h3 id="ä¸‰ã€å®ç°-then-æ–¹æ³•å¤šæ¬¡è°ƒç”¨æ·»åŠ å¤šä¸ªå¤„ç†å‡½æ•°"><a href="#ä¸‰ã€å®ç°-then-æ–¹æ³•å¤šæ¬¡è°ƒç”¨æ·»åŠ å¤šä¸ªå¤„ç†å‡½æ•°" class="headerlink" title="ä¸‰ã€å®ç° then æ–¹æ³•å¤šæ¬¡è°ƒç”¨æ·»åŠ å¤šä¸ªå¤„ç†å‡½æ•°"></a>ä¸‰ã€å®ç° then æ–¹æ³•å¤šæ¬¡è°ƒç”¨æ·»åŠ å¤šä¸ªå¤„ç†å‡½æ•°</h3><blockquote>
<p>Promise çš„ then æ–¹æ³•æ˜¯å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨çš„ã€‚è¿™é‡Œå¦‚æœæœ‰ä¸‰ä¸ª then çš„è°ƒç”¨ï¼Œå¦‚æœæ˜¯åŒæ­¥å›è°ƒï¼Œé‚£ä¹ˆç›´æ¥è¿”å›å½“å‰çš„å€¼å°±è¡Œï¼›å¦‚æœæ˜¯å¼‚æ­¥å›è°ƒï¼Œé‚£ä¹ˆä¿å­˜çš„æˆåŠŸå¤±è´¥çš„å›è°ƒï¼Œéœ€è¦ç”¨ä¸åŒçš„å€¼ä¿å­˜ï¼Œå› ä¸ºéƒ½äº’ä¸ç›¸åŒã€‚ä¹‹å‰çš„ä»£ç éœ€è¦æ”¹è¿›ã€‚</p>
</blockquote>
<p>åŒæ ·çš„å…ˆçœ‹ä¸€ä¸ªğŸŒ°</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// test.js</span><br><br>const MyPromise = require(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br>const promise = <span class="hljs-keyword">new</span> MyPromise(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    resolve(<span class="hljs-string">&#x27;success&#x27;</span>)<br>  &#125;, <span class="hljs-number">2000</span>); <br>&#125;)<br><br>promise.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">1</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>&#125;)<br> <br>promise.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">2</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>&#125;)<br><br>promise.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>&#125;)<br><br><span class="hljs-comment">// 3</span><br><span class="hljs-comment">// resolve success</span><br><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>ç›®å‰çš„ä»£ç åªèƒ½è¾“å‡ºï¼š<code>3 resolve success</code>ï¼Œæ€ä¹ˆå¯ä»¥æŠŠ 1ã€2 å¼„ä¸¢å‘¢ï¼</p>
<p>æˆ‘ä»¬åº”è¯¥ä¸€è§†åŒä»ï¼Œä¿è¯æ‰€æœ‰ then ä¸­çš„å›è°ƒå‡½æ•°éƒ½å¯ä»¥æ‰§è¡Œ ğŸ¤” ç»§ç»­æ”¹é€ </p>
<h4 id="1-MyPromise-ç±»ä¸­æ–°å¢ä¸¤ä¸ªæ•°ç»„"><a href="#1-MyPromise-ç±»ä¸­æ–°å¢ä¸¤ä¸ªæ•°ç»„" class="headerlink" title="1. MyPromise ç±»ä¸­æ–°å¢ä¸¤ä¸ªæ•°ç»„"></a>1. MyPromise ç±»ä¸­æ–°å¢ä¸¤ä¸ªæ•°ç»„</h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// MyPromise.js<br><br>// å­˜å‚¨æˆåŠŸå›è°ƒå‡½æ•°<br>// onFulfilledCallback <span class="hljs-operator">=</span> null<span class="hljs-comment">;</span><br><span class="hljs-attribute">onFulfilledCallbacks</span> <span class="hljs-operator">=</span> []<span class="hljs-comment">;</span><br>// å­˜å‚¨å¤±è´¥å›è°ƒå‡½æ•°<br>// onRejectedCallback <span class="hljs-operator">=</span> null<span class="hljs-comment">;</span><br><span class="hljs-attribute">onRejectedCallbacks</span> <span class="hljs-operator">=</span> []<span class="hljs-comment">;</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h4 id="2-å›è°ƒå‡½æ•°å­˜å…¥æ•°ç»„ä¸­"><a href="#2-å›è°ƒå‡½æ•°å­˜å…¥æ•°ç»„ä¸­" class="headerlink" title="2. å›è°ƒå‡½æ•°å­˜å…¥æ•°ç»„ä¸­"></a>2. å›è°ƒå‡½æ•°å­˜å…¥æ•°ç»„ä¸­</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br>then(onFulfilled, onRejected) &#123;<br>  <span class="hljs-comment">// åˆ¤æ–­çŠ¶æ€</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === FULFILLED) &#123;<br>    <span class="hljs-comment">// è°ƒç”¨æˆåŠŸå›è°ƒï¼Œå¹¶ä¸”æŠŠå€¼è¿”å›</span><br>    onFulfilled(<span class="hljs-keyword">this</span>.value);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === REJECTED) &#123;<br>    <span class="hljs-comment">// è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›</span><br>    onRejected(<span class="hljs-keyword">this</span>.reason);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>    <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>    <span class="hljs-comment">// å› ä¸ºä¸çŸ¥é“åé¢çŠ¶æ€çš„å˜åŒ–ï¼Œè¿™é‡Œå…ˆå°†æˆåŠŸå›è°ƒå’Œå¤±è´¥å›è°ƒå­˜å‚¨èµ·æ¥</span><br>    <span class="hljs-comment">// ç­‰å¾…åç»­è°ƒç”¨</span><br>    <span class="hljs-keyword">this</span>.onFulfilledCallbacks.push(onFulfilled);<br>    <span class="hljs-keyword">this</span>.onRejectedCallbacks.push(onRejected);<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h4 id="3-å¾ªç¯è°ƒç”¨æˆåŠŸå’Œå¤±è´¥å›è°ƒ"><a href="#3-å¾ªç¯è°ƒç”¨æˆåŠŸå’Œå¤±è´¥å›è°ƒ" class="headerlink" title="3. å¾ªç¯è°ƒç”¨æˆåŠŸå’Œå¤±è´¥å›è°ƒ"></a>3. å¾ªç¯è°ƒç”¨æˆåŠŸå’Œå¤±è´¥å›è°ƒ</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-comment">// æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€</span><br>resolve = (value) =&gt; &#123;<br>  <span class="hljs-comment">// åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>    <span class="hljs-comment">// çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ</span><br>    <span class="hljs-keyword">this</span>.status = FULFILLED;<br>    <span class="hljs-comment">// ä¿å­˜æˆåŠŸä¹‹åçš„å€¼</span><br>    <span class="hljs-keyword">this</span>.value = value;<br>    <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>    <span class="hljs-comment">// resolveé‡Œé¢å°†æ‰€æœ‰æˆåŠŸçš„å›è°ƒæ‹¿å‡ºæ¥æ‰§è¡Œ</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.onFulfilledCallbacks.length) &#123;<br>      <span class="hljs-comment">// Array.shift() å–å‡ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åï¼ˆï¼‰è°ƒç”¨ï¼Œshiftä¸æ˜¯çº¯å‡½æ•°ï¼Œå–å‡ºåï¼Œæ•°ç»„å°†å¤±å»è¯¥å…ƒç´ ï¼Œç›´åˆ°æ•°ç»„ä¸ºç©º</span><br>      <span class="hljs-keyword">this</span>.onFulfilledCallbacks.shift()(value)<br>    &#125;<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// MyPromise.js<br><br>// æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€<br><span class="hljs-attribute">reject</span> <span class="hljs-operator">=</span> (reason) <span class="hljs-operator">=</span>&gt; &#123;<br>  // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹<br>  if (this.status <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> PENDING) &#123;<br>    // çŠ¶æ€æˆåŠŸä¸ºå¤±è´¥<br>    this.status <span class="hljs-operator">=</span> REJECTED<span class="hljs-comment">;</span><br>    // ä¿å­˜å¤±è´¥åçš„åŸå› <br>    this.reason <span class="hljs-operator">=</span> reason<span class="hljs-comment">;</span><br>    // <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> æ–°å¢ <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><br>    // resolveé‡Œé¢å°†æ‰€æœ‰å¤±è´¥çš„å›è°ƒæ‹¿å‡ºæ¥æ‰§è¡Œ<br>    while (this.onRejectedCallbacks.length) &#123;<br>      this.onRejectedCallbacks.shift()(reason)<br>    &#125;<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>å†æ¥è¿è¡Œä¸€ä¸‹ï¼Œçœ‹çœ‹ç»“æœğŸ‘‡</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-built_in">resolve</span> success<br><span class="hljs-built_in">resolve</span> success<br><span class="hljs-built_in">resolve</span> success<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>ğŸ‘ğŸ‘ğŸ‘ å®Œç¾ï¼Œç»§ç»­</p>
<h3 id="å››ã€å®ç°-then-æ–¹æ³•çš„é“¾å¼è°ƒç”¨"><a href="#å››ã€å®ç°-then-æ–¹æ³•çš„é“¾å¼è°ƒç”¨" class="headerlink" title="å››ã€å®ç° then æ–¹æ³•çš„é“¾å¼è°ƒç”¨"></a>å››ã€å®ç° then æ–¹æ³•çš„é“¾å¼è°ƒç”¨</h3><blockquote>
<p>then æ–¹æ³•è¦é“¾å¼è°ƒç”¨é‚£ä¹ˆå°±éœ€è¦è¿”å›ä¸€ä¸ª Promise å¯¹è±¡<br>then æ–¹æ³•é‡Œé¢ return ä¸€ä¸ªè¿”å›å€¼ä½œä¸ºä¸‹ä¸€ä¸ª then æ–¹æ³•çš„å‚æ•°ï¼Œå¦‚æœæ˜¯ return ä¸€ä¸ª Promise å¯¹è±¡ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆ¤æ–­å®ƒçš„çŠ¶æ€</p>
</blockquote>
<p>ä¸¾ä¸ªæ —å­ ğŸŒ°</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// test.js</span><br><br>const MyPromise = require(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br>const promise = <span class="hljs-keyword">new</span> MyPromise(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// ç›®å‰è¿™é‡Œåªå¤„ç†åŒæ­¥çš„é—®é¢˜</span><br>  resolve(<span class="hljs-string">&#x27;success&#x27;</span>)<br>&#125;)<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">other</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MyPromise(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span>&#123;<br>    resolve(<span class="hljs-string">&#x27;other&#x27;</span>)<br>  &#125;)<br>&#125;<br>promise.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">1</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>  <span class="hljs-keyword">return</span> other()<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">2</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>&#125;)<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>ç”¨ç›®å‰çš„æ‰‹å†™ä»£ç è¿è¡Œçš„æ—¶å€™ä¼šæŠ¥é”™ ğŸ˜£ æ— æ³•é“¾å¼è°ƒç”¨</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arcade">&#125;).then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  ^<br><br>TypeError: Cannot read property <span class="hljs-string">&#x27;then&#x27;</span> of <span class="hljs-literal">undefined</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ¥ç€æ”¹ ğŸ’ª</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> &#123;<br>  ......<br>  then(onFulfilled, onRejected) &#123;<br>    <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>    <span class="hljs-comment">// ä¸ºäº†é“¾å¼è°ƒç”¨è¿™é‡Œç›´æ¥åˆ›å»ºä¸€ä¸ª MyPromiseï¼Œå¹¶åœ¨åé¢ return å‡ºå»</span><br>    <span class="hljs-keyword">const</span> promise2 = new MyPromise((resolve, reject) =&gt; &#123;<br>      <span class="hljs-comment">// è¿™é‡Œçš„å†…å®¹åœ¨æ‰§è¡Œå™¨ä¸­ï¼Œä¼šç«‹å³æ‰§è¡Œ</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === FULFILLED) &#123;<br>        <span class="hljs-comment">// è·å–æˆåŠŸå›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br>        <span class="hljs-keyword">const</span> x = onFulfilled(<span class="hljs-keyword">this</span>.value);<br>        <span class="hljs-comment">// ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†</span><br>        resolvePromise(x, resolve, reject);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === REJECTED) &#123;<br>        onRejected(<span class="hljs-keyword">this</span>.reason);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>        <span class="hljs-keyword">this</span>.onFulfilledCallbacks.push(onFulfilled);<br>        <span class="hljs-keyword">this</span>.onRejectedCallbacks.push(onRejected);<br>      &#125;<br>    &#125;) <br>    <br>    <span class="hljs-keyword">return</span> promise2;<br>  &#125;<br>&#125;<br><br>function resolvePromise(x, resolve, reject) &#123;<br>  <span class="hljs-comment">// åˆ¤æ–­xæ˜¯ä¸æ˜¯ MyPromise å®ä¾‹å¯¹è±¡</span><br>  <span class="hljs-keyword">if</span>(x instanceof MyPromise) &#123;<br>    <span class="hljs-comment">// æ‰§è¡Œ xï¼Œè°ƒç”¨ then æ–¹æ³•ï¼Œç›®çš„æ˜¯å°†å…¶çŠ¶æ€å˜ä¸º fulfilled æˆ–è€… rejected</span><br>    <span class="hljs-comment">// x.then(value =&gt; resolve(value), reason =&gt; reject(reason))</span><br>    <span class="hljs-comment">// ç®€åŒ–ä¹‹å</span><br>    x.then(resolve, reject)<br>  &#125; <span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-comment">// æ™®é€šå€¼</span><br>    resolve(x)<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸€ä¸‹ï¼Œç»“æœğŸ‘‡</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-built_in">resolve</span> success<br><span class="hljs-built_in">resolve</span> other<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>emâ€¦ ç¬¦åˆé¢„æœŸ ğŸ˜</p>
<h3 id="äº”ã€then-æ–¹æ³•é“¾å¼è°ƒç”¨è¯†åˆ«-Promise-æ˜¯å¦è¿”å›è‡ªå·±"><a href="#äº”ã€then-æ–¹æ³•é“¾å¼è°ƒç”¨è¯†åˆ«-Promise-æ˜¯å¦è¿”å›è‡ªå·±" class="headerlink" title="äº”ã€then æ–¹æ³•é“¾å¼è°ƒç”¨è¯†åˆ« Promise æ˜¯å¦è¿”å›è‡ªå·±"></a>äº”ã€then æ–¹æ³•é“¾å¼è°ƒç”¨è¯†åˆ« Promise æ˜¯å¦è¿”å›è‡ªå·±</h3><blockquote>
<p>å¦‚æœ then æ–¹æ³•è¿”å›çš„æ˜¯è‡ªå·±çš„ Promise å¯¹è±¡ï¼Œåˆ™ä¼šå‘ç”Ÿå¾ªç¯è°ƒç”¨ï¼Œè¿™ä¸ªæ—¶å€™ç¨‹åºä¼šæŠ¥é”™</p>
</blockquote>
<p>ä¾‹å¦‚ä¸‹é¢è¿™ç§æƒ…å†µğŸ‘‡</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// test.js</span><br><br><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  <span class="hljs-title function_">resolve</span>(<span class="hljs-number">100</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> p1 = promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)<br>  <span class="hljs-keyword">return</span> p1<br>&#125;)<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>ä½¿ç”¨åŸç”Ÿ Promise æ‰§è¡Œè¿™ä¸ªä»£ç ï¼Œä¼šæŠ¥ç±»å‹é”™è¯¯</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">Uncaught</span> (in promise) TypeError: Chaining cycle detected <span class="hljs-keyword">for</span> promise #&lt;Promise&gt;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨ MyPromise å®ç°ä¸€ä¸‹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> &#123;<br>  ......<br>  <span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) &#123;<br>    <span class="hljs-keyword">const</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">FULFILLED</span>) &#123;<br>        <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);<br>        <span class="hljs-comment">// resolvePromise é›†ä¸­å¤„ç†ï¼Œå°† promise2 ä¼ å…¥</span><br>        <span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">REJECTED</span>) &#123;<br>        <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">PENDING</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">push</span>(onFulfilled);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(onRejected);<br>      &#125;<br>    &#125;) <br>    <br>    <span class="hljs-keyword">return</span> promise2;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">resolvePromise</span>(<span class="hljs-params">promise2, x, resolve, reject</span>) &#123;<br>  <span class="hljs-comment">// å¦‚æœç›¸ç­‰äº†ï¼Œè¯´æ˜returnçš„æ˜¯è‡ªå·±ï¼ŒæŠ›å‡ºç±»å‹é”™è¯¯å¹¶è¿”å›</span><br>  <span class="hljs-keyword">if</span> (promise2 === x) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>))<br>  &#125;<br>  <span class="hljs-keyword">if</span>(x <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>) &#123;<br>    x.<span class="hljs-title function_">then</span>(resolve, reject)<br>  &#125; <span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_">resolve</span>(x)<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸€ä¸‹ï¼Œç«Ÿç„¶æŠ¥é”™äº† ğŸ˜±</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">resolvePromise(promise2, x, resolve, reject);<br>                       ^<br><br>ReferenceError: Cannot <span class="hljs-keyword">access</span> <span class="hljs-string">&#x27;promise2&#x27;</span> <span class="hljs-keyword">before</span> initialization<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>ä¸ºå•¥ä¼šæŠ¥é”™å‘¢ï¼Ÿä»é”™è¯¯æç¤ºå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å¿…é¡»è¦ç­‰ promise2 å®Œæˆåˆå§‹åŒ–ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¦ç”¨ä¸Šå®å¾®ä»»åŠ¡å’Œäº‹ä»¶å¾ªç¯çš„çŸ¥è¯†äº†ï¼Œè¿™é‡Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ªå¼‚æ­¥å‡½æ•°å»ç­‰å¾… promise2 å®Œæˆåˆå§‹åŒ–ï¼Œå‰é¢æˆ‘ä»¬å·²ç»ç¡®è®¤äº†åˆ›å»ºå¾®ä»»åŠ¡çš„æŠ€æœ¯æ–¹æ¡ˆ â€“&gt; <code>queueMicrotask</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> &#123;<br>  ......<br>  <span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) &#123;<br>    <span class="hljs-keyword">const</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">FULFILLED</span>) &#123;<br>        <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ç­‰å¾… promise2 å®Œæˆåˆå§‹åŒ–</span><br>        <span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>          <span class="hljs-comment">// è·å–æˆåŠŸå›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br>          <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);<br>          <span class="hljs-comment">// ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†</span><br>          <span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);<br>        &#125;)  <br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">REJECTED</span>) &#123;<br>      ......<br>    &#125;) <br>    <br>    <span class="hljs-keyword">return</span> promise2;<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸€ä¸‹</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// test.js</span><br><br>const MyPromise = require(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br>const promise = <span class="hljs-keyword">new</span> MyPromise(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    resolve(<span class="hljs-string">&#x27;success&#x27;</span>)<br>&#125;)<br> <br><span class="hljs-comment">// è¿™ä¸ªæ—¶å€™å°†promiseå®šä¹‰ä¸€ä¸ªp1ï¼Œç„¶åè¿”å›çš„æ—¶å€™è¿”å›p1è¿™ä¸ªpromise</span><br>const p1 = promise.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>   <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">1</span>)<br>   <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>   <span class="hljs-keyword">return</span> p1<br>&#125;)<br> <br><span class="hljs-comment">// è¿è¡Œçš„æ—¶å€™ä¼šèµ°reject</span><br>p1.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">2</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>&#125;, reason =&gt; &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(reason.message)<br>&#125;)<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œå¾—åˆ°æˆ‘ä»¬çš„ç»“æœ ğŸ‘‡</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-built_in">resolve</span> success<br>Chaining cycle detected <span class="hljs-keyword">for</span> promise <span class="hljs-comment">#&lt;Promise&gt;</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>å“ˆå“ˆï¼Œæå®š ğŸ˜ å¼€å§‹ä¸‹ä¸€æ­¥</p>
<h3 id="å…­ã€æ•è·é”™è¯¯åŠ-then-é“¾å¼è°ƒç”¨å…¶ä»–çŠ¶æ€ä»£ç è¡¥å……"><a href="#å…­ã€æ•è·é”™è¯¯åŠ-then-é“¾å¼è°ƒç”¨å…¶ä»–çŠ¶æ€ä»£ç è¡¥å……" class="headerlink" title="å…­ã€æ•è·é”™è¯¯åŠ then é“¾å¼è°ƒç”¨å…¶ä»–çŠ¶æ€ä»£ç è¡¥å……"></a>å…­ã€æ•è·é”™è¯¯åŠ then é“¾å¼è°ƒç”¨å…¶ä»–çŠ¶æ€ä»£ç è¡¥å……</h3><p>ç›®å‰è¿˜ç¼ºå°‘é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ï¼Œå°±æ˜¯æˆ‘ä»¬çš„é”™è¯¯æ•è·è¿˜æ²¡æœ‰å¤„ç†</p>
<h4 id="1-æ•è·æ‰§è¡Œå™¨é”™è¯¯"><a href="#1-æ•è·æ‰§è¡Œå™¨é”™è¯¯" class="headerlink" title="1. æ•è·æ‰§è¡Œå™¨é”™è¯¯"></a>1. æ•è·æ‰§è¡Œå™¨é”™è¯¯</h4><blockquote>
<p>æ•è·æ‰§è¡Œå™¨ä¸­çš„ä»£ç ï¼Œå¦‚æœæ‰§è¡Œå™¨ä¸­æœ‰ä»£ç é”™è¯¯ï¼Œé‚£ä¹ˆ Promise çš„çŠ¶æ€è¦å˜ä¸ºå¤±è´¥</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-keyword">constructor</span>(executor)&#123;<br>  <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>  <span class="hljs-comment">// executor æ˜¯ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿›å…¥ä¼šç«‹å³æ‰§è¡Œ</span><br>  <span class="hljs-comment">// å¹¶ä¼ å…¥resolveå’Œrejectæ–¹æ³•</span><br>  <span class="hljs-keyword">try</span> &#123;<br>    executor(<span class="hljs-keyword">this</span>.resolve, <span class="hljs-keyword">this</span>.reject)<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-comment">// å¦‚æœæœ‰é”™è¯¯ï¼Œå°±ç›´æ¥æ‰§è¡Œ reject</span><br>    <span class="hljs-keyword">this</span>.reject(error)<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>éªŒè¯ä¸€ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// test.js</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyPromise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// resolve(&#x27;success&#x27;)</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;æ‰§è¡Œå™¨é”™è¯¯&#x27;</span>)<br>&#125;)<br> <br>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason.<span class="hljs-property">message</span>)<br>&#125;)<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ ğŸ‘‡</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">æ‰§è¡Œå™¨é”™è¯¯<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>OKï¼Œé€šè¿‡ ğŸ˜€</p>
<h4 id="2-then-æ‰§è¡Œçš„æ—¶é”™è¯¯æ•è·"><a href="#2-then-æ‰§è¡Œçš„æ—¶é”™è¯¯æ•è·" class="headerlink" title="2. then æ‰§è¡Œçš„æ—¶é”™è¯¯æ•è·"></a>2. then æ‰§è¡Œçš„æ—¶é”™è¯¯æ•è·</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br>then(onFulfilled, onRejected) &#123;<br>  <span class="hljs-comment">// ä¸ºäº†é“¾å¼è°ƒç”¨è¿™é‡Œç›´æ¥åˆ›å»ºä¸€ä¸ª MyPromiseï¼Œå¹¶åœ¨åé¢ return å‡ºå»</span><br>  <span class="hljs-keyword">const</span> promise2 = new MyPromise((resolve, reject) =&gt; &#123;<br>    <span class="hljs-comment">// åˆ¤æ–­çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === FULFILLED) &#123;<br>      <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ç­‰å¾… promise2 å®Œæˆåˆå§‹åŒ–</span><br>      queueMicrotask(() =&gt; &#123;<br>        <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// è·å–æˆåŠŸå›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br>          <span class="hljs-keyword">const</span> x = onFulfilled(<span class="hljs-keyword">this</span>.value);<br>          <span class="hljs-comment">// ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†</span><br>          resolvePromise(promise2, x, resolve, reject);<br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>          reject(error)<br>        &#125;  <br>      &#125;)  <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === REJECTED) &#123;<br>      <span class="hljs-comment">// è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›</span><br>      onRejected(<span class="hljs-keyword">this</span>.reason);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>      <span class="hljs-comment">// ç­‰å¾…</span><br>      <span class="hljs-comment">// å› ä¸ºä¸çŸ¥é“åé¢çŠ¶æ€çš„å˜åŒ–æƒ…å†µï¼Œæ‰€ä»¥å°†æˆåŠŸå›è°ƒå’Œå¤±è´¥å›è°ƒå­˜å‚¨èµ·æ¥</span><br>      <span class="hljs-comment">// ç­‰åˆ°æ‰§è¡ŒæˆåŠŸå¤±è´¥å‡½æ•°çš„æ—¶å€™å†ä¼ é€’</span><br>      <span class="hljs-keyword">this</span>.onFulfilledCallbacks.push(onFulfilled);<br>      <span class="hljs-keyword">this</span>.onRejectedCallbacks.push(onRejected);<br>    &#125;<br>  &#125;) <br>  <br>  <span class="hljs-keyword">return</span> promise2;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>éªŒè¯ä¸€ä¸‹ï¼š</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// test.js</span><br><br>const MyPromise = require(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br>const promise = <span class="hljs-keyword">new</span> MyPromise(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    resolve(<span class="hljs-string">&#x27;success&#x27;</span>)<br>    <span class="hljs-comment">// throw new Error(&#x27;æ‰§è¡Œå™¨é”™è¯¯&#x27;)</span><br> &#125;)<br> <br><span class="hljs-comment">// ç¬¬ä¸€ä¸ªthenæ–¹æ³•ä¸­çš„é”™è¯¯è¦åœ¨ç¬¬äºŒä¸ªthenæ–¹æ³•ä¸­æ•è·åˆ°</span><br>promise.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">1</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">&#x27;resolve&#x27;</span>, value)<br>  throw <span class="hljs-keyword">new</span> Error(<span class="hljs-string">&#x27;then error&#x27;</span>)<br>&#125;, reason =&gt; &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">2</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(reason.message)<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(value);<br>&#125;, reason =&gt; &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">4</span>)<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(reason.message)<br>&#125;)<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ ğŸ‘‡</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">resolve</span> success<br>then <span class="hljs-literal">error</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>è¿™é‡ŒæˆåŠŸæ‰“å°äº† 1 ä¸­æŠ›å‡ºçš„é”™è¯¯ <code>then error</code></p>
<h3 id="ä¸ƒã€å‚è€ƒ-fulfilled-çŠ¶æ€ä¸‹çš„å¤„ç†æ–¹å¼ï¼Œå¯¹-rejected-å’Œ-pending-çŠ¶æ€è¿›è¡Œæ”¹é€ "><a href="#ä¸ƒã€å‚è€ƒ-fulfilled-çŠ¶æ€ä¸‹çš„å¤„ç†æ–¹å¼ï¼Œå¯¹-rejected-å’Œ-pending-çŠ¶æ€è¿›è¡Œæ”¹é€ " class="headerlink" title="ä¸ƒã€å‚è€ƒ fulfilled çŠ¶æ€ä¸‹çš„å¤„ç†æ–¹å¼ï¼Œå¯¹ rejected å’Œ pending çŠ¶æ€è¿›è¡Œæ”¹é€ "></a>ä¸ƒã€å‚è€ƒ fulfilled çŠ¶æ€ä¸‹çš„å¤„ç†æ–¹å¼ï¼Œå¯¹ rejected å’Œ pending çŠ¶æ€è¿›è¡Œæ”¹é€ </h3><p><strong>æ”¹é€ å†…å®¹åŒ…æ‹¬ï¼š</strong></p>
<blockquote>
<ol>
<li>å¢åŠ å¼‚æ­¥çŠ¶æ€ä¸‹çš„é“¾å¼è°ƒç”¨</li>
<li>å¢åŠ å›è°ƒå‡½æ•°æ‰§è¡Œç»“æœçš„åˆ¤æ–­</li>
<li>å¢åŠ è¯†åˆ« Promise æ˜¯å¦è¿”å›è‡ªå·±</li>
<li>å¢åŠ é”™è¯¯æ•è·</li>
</ol>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br>then(onFulfilled, onRejected) &#123;<br>  <span class="hljs-comment">// ä¸ºäº†é“¾å¼è°ƒç”¨è¿™é‡Œç›´æ¥åˆ›å»ºä¸€ä¸ª MyPromiseï¼Œå¹¶åœ¨åé¢ return å‡ºå»</span><br>  <span class="hljs-keyword">const</span> promise2 = new MyPromise((resolve, reject) =&gt; &#123;<br>    <span class="hljs-comment">// åˆ¤æ–­çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === FULFILLED) &#123;<br>      <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ç­‰å¾… promise2 å®Œæˆåˆå§‹åŒ–</span><br>      queueMicrotask(() =&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// è·å–æˆåŠŸå›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br>          <span class="hljs-keyword">const</span> x = onFulfilled(<span class="hljs-keyword">this</span>.value);<br>          <span class="hljs-comment">// ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†</span><br>          resolvePromise(promise2, x, resolve, reject);<br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>          reject(error)<br>        &#125; <br>      &#125;)  <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === REJECTED) &#123; <br>      <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>      <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ç­‰å¾… promise2 å®Œæˆåˆå§‹åŒ–</span><br>      queueMicrotask(() =&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›</span><br>          <span class="hljs-keyword">const</span> x = onRejected(<span class="hljs-keyword">this</span>.reason);<br>          <span class="hljs-comment">// ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†</span><br>          resolvePromise(promise2, x, resolve, reject);<br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>          reject(error)<br>        &#125; <br>      &#125;) <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>      <span class="hljs-comment">// ç­‰å¾…</span><br>      <span class="hljs-comment">// å› ä¸ºä¸çŸ¥é“åé¢çŠ¶æ€çš„å˜åŒ–æƒ…å†µï¼Œæ‰€ä»¥å°†æˆåŠŸå›è°ƒå’Œå¤±è´¥å›è°ƒå­˜å‚¨èµ·æ¥</span><br>      <span class="hljs-comment">// ç­‰åˆ°æ‰§è¡ŒæˆåŠŸå¤±è´¥å‡½æ•°çš„æ—¶å€™å†ä¼ é€’</span><br>      <span class="hljs-keyword">this</span>.onFulfilledCallbacks.push(() =&gt; &#123;<br>        <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>        queueMicrotask(() =&gt; &#123;<br>          <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è·å–æˆåŠŸå›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br>            <span class="hljs-keyword">const</span> x = onFulfilled(<span class="hljs-keyword">this</span>.value);<br>            <span class="hljs-comment">// ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†</span><br>            resolvePromise(promise2, x, resolve, reject);<br>          &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>            reject(error)<br>          &#125; <br>        &#125;) <br>      &#125;);<br>      <span class="hljs-keyword">this</span>.onRejectedCallbacks.push(() =&gt; &#123;<br>        <span class="hljs-comment">// ==== æ–°å¢ ====</span><br>        queueMicrotask(() =&gt; &#123;<br>          <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›</span><br>            <span class="hljs-keyword">const</span> x = onRejected(<span class="hljs-keyword">this</span>.reason);<br>            <span class="hljs-comment">// ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†</span><br>            resolvePromise(promise2, x, resolve, reject);<br>          &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>            reject(error)<br>          &#125; <br>        &#125;) <br>      &#125;);<br>    &#125;<br>  &#125;) <br>  <br>  <span class="hljs-keyword">return</span> promise2;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h3 id="å…«ã€then-ä¸­çš„å‚æ•°å˜ä¸ºå¯é€‰"><a href="#å…«ã€then-ä¸­çš„å‚æ•°å˜ä¸ºå¯é€‰" class="headerlink" title="å…«ã€then ä¸­çš„å‚æ•°å˜ä¸ºå¯é€‰"></a>å…«ã€then ä¸­çš„å‚æ•°å˜ä¸ºå¯é€‰</h3><p>ä¸Šé¢æˆ‘ä»¬å¤„ç† then æ–¹æ³•çš„æ—¶å€™éƒ½æ˜¯é»˜è®¤ä¼ å…¥ onFulfilledã€onRejected ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œä½†æ˜¯å®é™…ä¸ŠåŸç”Ÿ Promise æ˜¯å¯ä»¥é€‰æ‹©å‚æ•°çš„å•ä¼ æˆ–è€…ä¸ä¼ ï¼Œéƒ½ä¸ä¼šå½±å“æ‰§è¡Œã€‚</p>
<p>ä¾‹å¦‚ä¸‹é¢è¿™ç§ ğŸ‘‡</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// test.js</span><br><br>const promise = <span class="hljs-keyword">new</span> Promise(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  resolve(<span class="hljs-number">100</span>)<br>&#125;)<br><br>promise<br>  .then()<br>  .then()<br>  .then()<br>  .then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(value))<br><br><span class="hljs-comment">// è¾“å‡º 100</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹ then æ–¹æ³•åšä¸€ç‚¹å°å°çš„è°ƒæ•´</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) &#123;<br>  <span class="hljs-comment">// å¦‚æœä¸ä¼ ï¼Œå°±ä½¿ç”¨é»˜è®¤å‡½æ•°</span><br>  onFulfilled = <span class="hljs-keyword">typeof</span> onFulfilled === <span class="hljs-string">&#x27;function&#x27;</span> ? onFulfilled : <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value;<br>  onRejected = <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">&#x27;function&#x27;</span> ? onRejected : <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<span class="hljs-keyword">throw</span> reason&#125;;<br><br>  <span class="hljs-comment">// ä¸ºäº†é“¾å¼è°ƒç”¨è¿™é‡Œç›´æ¥åˆ›å»ºä¸€ä¸ª MyPromiseï¼Œå¹¶åœ¨åé¢ return å‡ºå»</span><br>  <span class="hljs-keyword">const</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  ......<br>&#125;<br><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ”¹é€ å®Œè‡ªç„¶æ˜¯éœ€è¦éªŒè¯ä¸€ä¸‹çš„</p>
<p><strong>å…ˆçœ‹æƒ…å†µä¸€</strong>ï¼šresolve ä¹‹å</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// test.js</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyPromise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;succ&#x27;</span>)<br>&#125;)<br> <br>promise.<span class="hljs-title function_">then</span>().<span class="hljs-title function_">then</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value))<br><br><span class="hljs-comment">// æ‰“å° succ</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p><strong>å…ˆçœ‹æƒ…å†µä¸€</strong>ï¼šreject ä¹‹å</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// test.js</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyPromise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;err&#x27;</span>)<br>&#125;)<br> <br>promise.<span class="hljs-title function_">then</span>().<span class="hljs-title function_">then</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value), <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason))<br><br><span class="hljs-comment">// æ‰“å° err</span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>å†™åˆ°è¿™é‡Œï¼Œéº»é›€ç‰ˆçš„ Promise åŸºæœ¬å®Œæˆäº†ï¼Œé¼“æŒ ğŸ‘ğŸ‘ğŸ‘</p>
<h3 id="ä¹ã€å®ç°-resolve-ä¸-reject-çš„é™æ€è°ƒç”¨"><a href="#ä¹ã€å®ç°-resolve-ä¸-reject-çš„é™æ€è°ƒç”¨" class="headerlink" title="ä¹ã€å®ç° resolve ä¸ reject çš„é™æ€è°ƒç”¨"></a>ä¹ã€å®ç° resolve ä¸ reject çš„é™æ€è°ƒç”¨</h3><p>å°±åƒå¼€å¤´æŒ‚çš„é‚£é“é¢è¯•é¢˜ä½¿ç”¨ <code>return Promise.resolve</code> æ¥è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæˆ‘ä»¬ç”¨ç°åœ¨çš„æ‰‹å†™ä»£ç å°è¯•ä¸€ä¸‹</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs arcade">const MyPromise = require(<span class="hljs-string">&#x27;./MyPromise&#x27;</span>)<br><br>MyPromise.resolve().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> MyPromise.resolve(<span class="hljs-number">4</span>);<br>&#125;).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(res)<br>&#125;)<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>ç»“æœå®ƒæŠ¥é”™äº† ğŸ˜¥</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">MyPromise.resolve().<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>          ^<br><br>TypeError: MyPromise.resolve <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> a function<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>é™¤äº† Promise.resolve è¿˜æœ‰ Promise.reject çš„ç”¨æ³•ï¼Œæˆ‘ä»¬éƒ½è¦å»æ”¯æŒï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-title class_">MyPromise</span> &#123;<br>  ......<br>  <span class="hljs-comment">// resolve é™æ€æ–¹æ³•</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span> (parameter) &#123;<br>    <span class="hljs-comment">// å¦‚æœä¼ å…¥ MyPromise å°±ç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> (parameter <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>) &#123;<br>      <span class="hljs-keyword">return</span> parameter;<br>    &#125;<br><br>    <span class="hljs-comment">// è½¬æˆå¸¸è§„æ–¹å¼</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span>  &#123;<br>      <span class="hljs-title function_">resolve</span>(parameter);<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-comment">// reject é™æ€æ–¹æ³•</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">reject</span> (reason) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">reject</span>(reason);<br>    &#125;);<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬å†æµ‹è¯•ä¸Šé¢çš„ ğŸŒ° å°±ä¸ä¼šæœ‰é—®é¢˜å•¦</p>
<p>æ‰§è¡Œç»“æœ ğŸ‘‡</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œæ‰‹å†™å·¥ä½œå°±åŸºæœ¬å®Œæˆäº†ï¼Œå‰é¢ä¸»è¦ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæ‰€ä»¥æœ‰ä¸€äº›å†—ä½™ä»£ç ï¼Œæˆ‘è§„æ•´ä¸€ä¸‹</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-comment">// å…ˆå®šä¹‰ä¸‰ä¸ªå¸¸é‡è¡¨ç¤ºçŠ¶æ€</span><br><span class="hljs-keyword">const</span> PENDING = <span class="hljs-string">&#x27;pending&#x27;</span>;<br><span class="hljs-keyword">const</span> FULFILLED = <span class="hljs-string">&#x27;fulfilled&#x27;</span>;<br><span class="hljs-keyword">const</span> REJECTED = <span class="hljs-string">&#x27;rejected&#x27;</span>;<br><br><span class="hljs-comment">// æ–°å»º MyPromise ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> &#123;<br>  <span class="hljs-keyword">constructor</span>(executor)&#123;<br>    <span class="hljs-comment">// executor æ˜¯ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿›å…¥ä¼šç«‹å³æ‰§è¡Œ</span><br>    <span class="hljs-comment">// å¹¶ä¼ å…¥resolveå’Œrejectæ–¹æ³•</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      executor(<span class="hljs-keyword">this</span>.resolve, <span class="hljs-keyword">this</span>.reject)<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      <span class="hljs-keyword">this</span>.reject(error)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// å‚¨å­˜çŠ¶æ€çš„å˜é‡ï¼Œåˆå§‹å€¼æ˜¯ pending</span><br>  status = PENDING;<br>  <span class="hljs-comment">// æˆåŠŸä¹‹åçš„å€¼</span><br>  value = <span class="hljs-literal">null</span>;<br>  <span class="hljs-comment">// å¤±è´¥ä¹‹åçš„åŸå› </span><br>  reason = <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-comment">// å­˜å‚¨æˆåŠŸå›è°ƒå‡½æ•°</span><br>  onFulfilledCallbacks = [];<br>  <span class="hljs-comment">// å­˜å‚¨å¤±è´¥å›è°ƒå‡½æ•°</span><br>  onRejectedCallbacks = [];<br><br>  <span class="hljs-comment">// æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€</span><br>  resolve = (value) =&gt; &#123;<br>    <span class="hljs-comment">// åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>      <span class="hljs-comment">// çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ</span><br>      <span class="hljs-keyword">this</span>.status = FULFILLED;<br>      <span class="hljs-comment">// ä¿å­˜æˆåŠŸä¹‹åçš„å€¼</span><br>      <span class="hljs-keyword">this</span>.value = value;<br>      <span class="hljs-comment">// resolveé‡Œé¢å°†æ‰€æœ‰æˆåŠŸçš„å›è°ƒæ‹¿å‡ºæ¥æ‰§è¡Œ</span><br>      <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.onFulfilledCallbacks.length) &#123;<br>        <span class="hljs-comment">// Array.shift() å–å‡ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åï¼ˆï¼‰è°ƒç”¨ï¼Œshiftä¸æ˜¯çº¯å‡½æ•°ï¼Œå–å‡ºåï¼Œæ•°ç»„å°†å¤±å»è¯¥å…ƒç´ ï¼Œç›´åˆ°æ•°ç»„ä¸ºç©º</span><br>        <span class="hljs-keyword">this</span>.onFulfilledCallbacks.shift()(value)<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€</span><br>  reject = (reason) =&gt; &#123;<br>    <span class="hljs-comment">// åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>      <span class="hljs-comment">// çŠ¶æ€æˆåŠŸä¸ºå¤±è´¥</span><br>      <span class="hljs-keyword">this</span>.status = REJECTED;<br>      <span class="hljs-comment">// ä¿å­˜å¤±è´¥åçš„åŸå› </span><br>      <span class="hljs-keyword">this</span>.reason = reason;<br>      <span class="hljs-comment">// resolveé‡Œé¢å°†æ‰€æœ‰å¤±è´¥çš„å›è°ƒæ‹¿å‡ºæ¥æ‰§è¡Œ</span><br>      <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.onRejectedCallbacks.length) &#123;<br>        <span class="hljs-keyword">this</span>.onRejectedCallbacks.shift()(reason)<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  then(onFulfilled, onRejected) &#123;<br>    <span class="hljs-keyword">const</span> realOnFulfilled = typeof onFulfilled === <span class="hljs-string">&#x27;function&#x27;</span> ? onFulfilled : value =&gt; value;<br>    <span class="hljs-keyword">const</span> realOnRejected = typeof onRejected === <span class="hljs-string">&#x27;function&#x27;</span> ? onRejected : reason =&gt; &#123;<span class="hljs-keyword">throw</span> reason&#125;;<br><br>    <span class="hljs-comment">// ä¸ºäº†é“¾å¼è°ƒç”¨è¿™é‡Œç›´æ¥åˆ›å»ºä¸€ä¸ª MyPromiseï¼Œå¹¶åœ¨åé¢ return å‡ºå»</span><br>    <span class="hljs-keyword">const</span> promise2 = new MyPromise((resolve, reject) =&gt; &#123;<br>      <span class="hljs-keyword">const</span> fulfilledMicrotask = () =&gt;  &#123;<br>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ç­‰å¾… promise2 å®Œæˆåˆå§‹åŒ–</span><br>        queueMicrotask(() =&gt; &#123;<br>          <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è·å–æˆåŠŸå›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br>            <span class="hljs-keyword">const</span> x = realOnFulfilled(<span class="hljs-keyword">this</span>.value);<br>            <span class="hljs-comment">// ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†</span><br>            resolvePromise(promise2, x, resolve, reject);<br>          &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>            reject(error)<br>          &#125; <br>        &#125;)  <br>      &#125;<br><br>      <span class="hljs-keyword">const</span> rejectedMicrotask = () =&gt; &#123; <br>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ç­‰å¾… promise2 å®Œæˆåˆå§‹åŒ–</span><br>        queueMicrotask(() =&gt; &#123;<br>          <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›</span><br>            <span class="hljs-keyword">const</span> x = realOnRejected(<span class="hljs-keyword">this</span>.reason);<br>            <span class="hljs-comment">// ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†</span><br>            resolvePromise(promise2, x, resolve, reject);<br>          &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>            reject(error)<br>          &#125; <br>        &#125;) <br>      &#125;<br>      <span class="hljs-comment">// åˆ¤æ–­çŠ¶æ€</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === FULFILLED) &#123;<br>        fulfilledMicrotask() <br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === REJECTED) &#123; <br>        rejectedMicrotask()<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.status === PENDING) &#123;<br>        <span class="hljs-comment">// ç­‰å¾…</span><br>        <span class="hljs-comment">// å› ä¸ºä¸çŸ¥é“åé¢çŠ¶æ€çš„å˜åŒ–æƒ…å†µï¼Œæ‰€ä»¥å°†æˆåŠŸå›è°ƒå’Œå¤±è´¥å›è°ƒå­˜å‚¨èµ·æ¥</span><br>        <span class="hljs-comment">// ç­‰åˆ°æ‰§è¡ŒæˆåŠŸå¤±è´¥å‡½æ•°çš„æ—¶å€™å†ä¼ é€’</span><br>        <span class="hljs-keyword">this</span>.onFulfilledCallbacks.push(fulfilledMicrotask);<br>        <span class="hljs-keyword">this</span>.onRejectedCallbacks.push(rejectedMicrotask);<br>      &#125;<br>    &#125;) <br>    <br>    <span class="hljs-keyword">return</span> promise2;<br>  &#125;<br><br>  <span class="hljs-comment">// resolve é™æ€æ–¹æ³•</span><br>  static resolve (parameter) &#123;<br>    <span class="hljs-comment">// å¦‚æœä¼ å…¥ MyPromise å°±ç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> (parameter instanceof MyPromise) &#123;<br>      <span class="hljs-keyword">return</span> parameter;<br>    &#125;<br><br>    <span class="hljs-comment">// è½¬æˆå¸¸è§„æ–¹å¼</span><br>    <span class="hljs-keyword">return</span> new MyPromise(resolve =&gt;  &#123;<br>      resolve(parameter);<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-comment">// reject é™æ€æ–¹æ³•</span><br>  static reject (reason) &#123;<br>    <span class="hljs-keyword">return</span> new MyPromise((resolve, reject) =&gt; &#123;<br>      reject(reason);<br>    &#125;);<br>  &#125;<br>&#125;<br><br>function resolvePromise(promise2, x, resolve, reject) &#123;<br>  <span class="hljs-comment">// å¦‚æœç›¸ç­‰äº†ï¼Œè¯´æ˜returnçš„æ˜¯è‡ªå·±ï¼ŒæŠ›å‡ºç±»å‹é”™è¯¯å¹¶è¿”å›</span><br>  <span class="hljs-keyword">if</span> (promise2 === x) &#123;<br>    <span class="hljs-keyword">return</span> reject(new TypeError(<span class="hljs-string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>))<br>  &#125;<br>  <span class="hljs-comment">// åˆ¤æ–­xæ˜¯ä¸æ˜¯ MyPromise å®ä¾‹å¯¹è±¡</span><br>  <span class="hljs-keyword">if</span>(x instanceof MyPromise) &#123;<br>    <span class="hljs-comment">// æ‰§è¡Œ xï¼Œè°ƒç”¨ then æ–¹æ³•ï¼Œç›®çš„æ˜¯å°†å…¶çŠ¶æ€å˜ä¸º fulfilled æˆ–è€… rejected</span><br>    <span class="hljs-comment">// x.then(value =&gt; resolve(value), reason =&gt; reject(reason))</span><br>    <span class="hljs-comment">// ç®€åŒ–ä¹‹å</span><br>    x.then(resolve, reject)<br>  &#125; <span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-comment">// æ™®é€šå€¼</span><br>    resolve(x)<br>  &#125;<br>&#125;<br><br>module.exports = MyPromise;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>åˆ°è¿™ä¸€æ­¥æ‰‹å†™éƒ¨åˆ†åŸºæœ¬å¤§åŠŸå‘Šæˆ ğŸ‰ğŸ‰ğŸ‰</p>
<h2 id="Promise-A-æµ‹è¯•"><a href="#Promise-A-æµ‹è¯•" class="headerlink" title="Promise A+ æµ‹è¯•"></a>Promise A+ æµ‹è¯•</h2><p>ä¸Šé¢ä»‹ç»äº† Promise A+ è§„èŒƒï¼Œå½“ç„¶æˆ‘ä»¬æ‰‹å†™çš„ç‰ˆæœ¬ä¹Ÿå¾—ç¬¦åˆäº†è¿™ä¸ªè§„èŒƒæ‰æœ‰èµ„æ ¼å« Promiseï¼Œ ä¸ç„¶å°±åªèƒ½æ˜¯ä¼ª Promise äº†ã€‚</p>
<p>ä¸Šæ–‡è®²åˆ°äº† <code>promises-aplus-tests</code>ï¼Œç°åœ¨æˆ‘ä»¬æ­£å¼å¼€ç®±ä½¿ç”¨</p>
<h4 id="1-å®‰è£…ä¸€ä¸‹"><a href="#1-å®‰è£…ä¸€ä¸‹" class="headerlink" title="1. å®‰è£…ä¸€ä¸‹"></a>1. å®‰è£…ä¸€ä¸‹</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmake">npm <span class="hljs-keyword">install</span> promises-aplus-tests -D<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h4 id="2-æ‰‹å†™ä»£ç ä¸­åŠ å…¥-deferred"><a href="#2-æ‰‹å†™ä»£ç ä¸­åŠ å…¥-deferred" class="headerlink" title="2. æ‰‹å†™ä»£ç ä¸­åŠ å…¥ deferred"></a>2. æ‰‹å†™ä»£ç ä¸­åŠ å…¥ deferred</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-title class_">MyPromise</span> &#123;<br>  ......<br>&#125;<br><br><span class="hljs-title class_">MyPromise</span>.<span class="hljs-property">deferred</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">var</span> result = &#123;&#125;;<br>  result.<span class="hljs-property">promise</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) &#123;<br>    result.<span class="hljs-property">resolve</span> = resolve;<br>    result.<span class="hljs-property">reject</span> = reject;<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">MyPromise</span>;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<h4 id="3-é…ç½®å¯åŠ¨å‘½ä»¤"><a href="#3-é…ç½®å¯åŠ¨å‘½ä»¤" class="headerlink" title="3. é…ç½®å¯åŠ¨å‘½ä»¤"></a>3. é…ç½®å¯åŠ¨å‘½ä»¤</h4><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;<br>  <span class="hljs-string">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;promise&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.0.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my promise&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;main&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;MyPromise.js&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> &#123;<br>    <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;promises-aplus-tests MyPromise&quot;</span><br>  &#125;<span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;author&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ITEM&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;license&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ISC&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-string">&quot;devDependencies&quot;</span><span class="hljs-punctuation">:</span> &#123;<br>    <span class="hljs-string">&quot;promises-aplus-tests&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^2.1.2&quot;</span><br>  &#125;<br>&#125;<br><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>å¼€å¯æµ‹è¯•</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">npm <span class="hljs-keyword">run</span><span class="language-bash"> <span class="hljs-built_in">test</span></span><br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>è¿«ä¸åŠå¾…äº†å§ ğŸ˜„ çœ‹çœ‹æˆ‘ä»¬çš„ç»“æœå¦‚ä½•ï¼Œèµ°èµ· ğŸ±â€ğŸ</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b6b60d615564bf892084c277f2e111b~tplv-k3u1fbpfcp-watermark.image" srcset="/img/loading.gif" lazyload></p>
<p>è™½ç„¶åŠŸèƒ½ä¸Šæ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯æµ‹è¯•å´å¤±è´¥äº† ğŸ˜¥</p>
<p>é’ˆå¯¹æç¤ºä¿¡æ¯ï¼Œæˆ‘ç¿»çœ‹äº†ä¸€ä¸‹ Promise A+ è§„èŒƒï¼Œå‘ç°æˆ‘ä»¬åº”è¯¥æ˜¯åœ¨ 2.3.x ä¸Šå‡ºç°äº†é—®é¢˜ï¼Œè¿™é‡Œè§„èŒƒä½¿ç”¨äº†ä¸åŒçš„æ–¹å¼è¿›è¡Œäº† then çš„è¿”å›å€¼åˆ¤æ–­ã€‚</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/535045144acb4d7794d05569b231e892~tplv-k3u1fbpfcp-watermark.image" srcset="/img/loading.gif" lazyload></p>
<p>è‡ªçº¢çº¿å‘ä¸‹çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬éƒ½æ²¡æœ‰å¤„ç†ï¼Œè¿™é‡Œè¦æ±‚åˆ¤æ–­ x æ˜¯å¦ä¸º object æˆ–è€… functionï¼Œæ»¡è¶³åˆ™æ¥ç€åˆ¤æ–­ x.then æ˜¯å¦å­˜åœ¨ï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºåˆ¤æ–­ x æ˜¯å¦ä¸º promiseï¼Œè¿™é‡Œéƒ½åŠŸèƒ½å®é™…ä¸æˆ‘ä»¬æ‰‹å†™ç‰ˆæœ¬ä¸­ <code>x instanceof MyPromise</code> åŠŸèƒ½ç›¸ä¼¼ã€‚</p>
<p>æˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§è§„èŒƒæ”¹é€ ä¸€ä¸‹ <code>resolvePromise</code> æ–¹æ³•å§</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">resolvePromise</span>(<span class="hljs-params">promise, x, resolve, reject</span>) &#123;<br>  <span class="hljs-comment">// å¦‚æœç›¸ç­‰äº†ï¼Œè¯´æ˜returnçš„æ˜¯è‡ªå·±ï¼ŒæŠ›å‡ºç±»å‹é”™è¯¯å¹¶è¿”å›</span><br>  <span class="hljs-keyword">if</span> (promise === x) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;The promise and the return value are the same&#x27;</span>));<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> x === <span class="hljs-string">&#x27;object&#x27;</span> || <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>    <span class="hljs-comment">// x ä¸º null ç›´æ¥è¿”å›ï¼Œèµ°åé¢çš„é€»è¾‘ä¼šæŠ¥é”™</span><br>    <span class="hljs-keyword">if</span> (x === <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(x);<br>    &#125;<br><br>    <span class="hljs-keyword">let</span> then;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// æŠŠ x.then èµ‹å€¼ç»™ then </span><br>      then = x.<span class="hljs-property">then</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      <span class="hljs-comment">// å¦‚æœå– x.then çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ error ï¼Œåˆ™ä»¥ error ä¸ºæ®å› æ‹’ç» promise</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(error);<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœ then æ˜¯å‡½æ•°</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> then === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>      <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        then.<span class="hljs-title function_">call</span>(<br>          x, <span class="hljs-comment">// this æŒ‡å‘ x</span><br>          <span class="hljs-comment">// å¦‚æœ resolvePromise ä»¥å€¼ y ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ [[Resolve]](promise, y)</span><br>          <span class="hljs-function"><span class="hljs-params">y</span> =&gt;</span> &#123;<br>            <span class="hljs-comment">// å¦‚æœ resolvePromise å’Œ rejectPromise å‡è¢«è°ƒç”¨ï¼Œ</span><br>            <span class="hljs-comment">// æˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨</span><br>            <span class="hljs-comment">// å®ç°è¿™æ¡éœ€è¦å‰é¢åŠ ä¸€ä¸ªå˜é‡ called</span><br>            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;<br>            called = <span class="hljs-literal">true</span>;<br>            <span class="hljs-title function_">resolvePromise</span>(promise, y, resolve, reject);<br>          &#125;,<br>          <span class="hljs-comment">// å¦‚æœ rejectPromise ä»¥æ®å›  r ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  r æ‹’ç» promise</span><br>          <span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> &#123;<br>            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;<br>            called = <span class="hljs-literal">true</span>;<br>            <span class="hljs-title function_">reject</span>(r);<br>          &#125;);<br>      &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        <span class="hljs-comment">// å¦‚æœè°ƒç”¨ then æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ errorï¼š</span><br>        <span class="hljs-comment">// å¦‚æœ resolvePromise æˆ– rejectPromise å·²ç»è¢«è°ƒç”¨ï¼Œç›´æ¥è¿”å›</span><br>        <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-comment">// å¦åˆ™ä»¥ error ä¸ºæ®å› æ‹’ç» promise</span><br>        <span class="hljs-title function_">reject</span>(error);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å¦‚æœ then ä¸æ˜¯å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise</span><br>      <span class="hljs-title function_">resolve</span>(x);<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœ x ä¸ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä»¥ x ä¸ºå‚æ•°æ‰§è¡Œ promise</span><br>    <span class="hljs-title function_">resolve</span>(x);<br>  &#125;<br>&#125;<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ”¹é€ åå¯åŠ¨æµ‹è¯•</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6c62e0df759748eb97b453ff94492877~tplv-k3u1fbpfcp-watermark.image" srcset="/img/loading.gif" lazyload></p>
<p>å®Œç¾é€šè¿‡ ğŸ‘ğŸ‘ğŸ‘</p>
<h2 id="æœ€ç»ˆæ—¶åˆ»ï¼Œå¦‚ä½•è§£é‡Šé‚£é“é¢è¯•é¢˜çš„æ‰§è¡Œç»“æœ"><a href="#æœ€ç»ˆæ—¶åˆ»ï¼Œå¦‚ä½•è§£é‡Šé‚£é“é¢è¯•é¢˜çš„æ‰§è¡Œç»“æœ" class="headerlink" title="æœ€ç»ˆæ—¶åˆ»ï¼Œå¦‚ä½•è§£é‡Šé‚£é“é¢è¯•é¢˜çš„æ‰§è¡Œç»“æœ"></a>æœ€ç»ˆæ—¶åˆ»ï¼Œå¦‚ä½•è§£é‡Šé‚£é“é¢è¯•é¢˜çš„æ‰§è¡Œç»“æœ</h2><p>å…ˆç”¨æˆ‘ä»¬è‡ªå·±çš„ Promise è¿è¡Œä¸€ä¸‹é‚£é“é¢è¯•é¢˜ ğŸ‘‡</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// test.js</span><br><br>const MyPromise = require(<span class="hljs-string">&#x27;./MyPromise.js&#x27;</span>)<br><br>MyPromise.resolve().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> MyPromise.resolve(<span class="hljs-number">4</span>);<br>&#125;).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(res)<br>&#125;)<br><br>MyPromise.resolve().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">1</span>);<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">2</span>);<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>);<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">5</span>);<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>&#123;<br>  <span class="hljs-built_in">console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-number">6</span>);<br>&#125;)<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š<strong>0ã€1ã€2ã€4ã€3ã€5ã€6</strong> ğŸ¤¯</p>
<p>è¿™é‡Œæˆ‘ä»¬æ‰‹å†™ç‰ˆæœ¬çš„ 4 å¹¶æ²¡æœ‰å’Œ åŸç”Ÿ Promise ä¸€æ ·åœ¨ 3 åé¢ï¼Œè€Œæ˜¯åœ¨ 2 åé¢</p>
<p>å…¶å®ä»æˆ‘ä»¬çš„æ‰‹å†™ä»£ç ä¸Šçœ‹ï¼Œåœ¨åˆ¤æ–­ then å†…éƒ¨å‡½æ•°æ‰§è¡Œç»“æœï¼Œä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œ ğŸ‘‡</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// MyPromise.js</span><br><br><span class="hljs-comment">// è·å–æˆåŠŸå›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br><span class="hljs-keyword">const</span> x = realOnFulfilled(<span class="hljs-keyword">this</span>.value);<br><span class="hljs-comment">// ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†</span><br>resolvePromise(promise2, x, resolve, reject);<br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>é¢è¯•é¢˜ä¸­ x ä¸º <code>MyPromise.resolve(4)</code> çš„æ—¶å€™ï¼Œåœ¨ä¼ å…¥ resolvePromise æ–¹æ³•ä¸­ä¼šå¯¹ x çš„ç±»å‹è¿›è¡Œåˆ¤æ–­æ—¶ï¼Œä¼šå‘ç°å®ƒæ˜¯ä¸€ä¸ª Promiseï¼Œå¹¶è®©å…¶è°ƒç”¨ then æ–¹æ³•å®ŒæˆçŠ¶æ€è½¬æ¢ã€‚å†çœ‹ resolvePromis æ–¹æ³•ä¸­è¿™ä¸€å—åˆ¤æ–­é€»è¾‘ ğŸ‘‡</p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs gml"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">typeof</span> <span class="hljs-variable language_">x</span> === <span class="hljs-string">&#x27;object&#x27;</span> || <span class="hljs-built_in">typeof</span> <span class="hljs-variable language_">x</span> === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>    <span class="hljs-comment">// x ä¸º null ç›´æ¥è¿”å›ï¼Œèµ°åé¢çš„é€»è¾‘ä¼šæŠ¥é”™</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">x</span> === null) &#123;<br>      <span class="hljs-keyword">return</span> resolve(<span class="hljs-variable language_">x</span>);<br>    &#125;<br><br>    let <span class="hljs-keyword">then</span>;<br>    try &#123;<br>      <span class="hljs-comment">// æŠŠ x.then èµ‹å€¼ç»™ then </span><br>      <span class="hljs-keyword">then</span> = <span class="hljs-variable language_">x</span>.<span class="hljs-keyword">then</span>;<br>    &#125; catch (error) &#123;<br>      <span class="hljs-comment">// å¦‚æœå– x.then çš„å€¼æ—¶æŠ›å‡ºé”™è¯¯ error ï¼Œåˆ™ä»¥ error ä¸ºæ®å› æ‹’ç» promise</span><br>      <span class="hljs-keyword">return</span> reject(error);<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœ then æ˜¯å‡½æ•°</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">typeof</span> <span class="hljs-keyword">then</span> === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>      let called = <span class="hljs-symbol">false</span>;<br>      try &#123;<br>        <span class="hljs-keyword">then</span>.call(<br>          <span class="hljs-variable language_">x</span>, <span class="hljs-comment">// this æŒ‡å‘ x</span><br>          <span class="hljs-comment">// å¦‚æœ resolvePromise ä»¥å€¼ y ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™è¿è¡Œ [[Resolve]](promise, y)</span><br>          <span class="hljs-variable language_">y</span> =&gt; &#123;<br>            <span class="hljs-comment">// å¦‚æœ resolvePromise å’Œ rejectPromise å‡è¢«è°ƒç”¨ï¼Œ</span><br>            <span class="hljs-comment">// æˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨</span><br>            <span class="hljs-comment">// å®ç°è¿™æ¡éœ€è¦å‰é¢åŠ ä¸€ä¸ªå˜é‡ called</span><br>            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;<br>            called = <span class="hljs-symbol">true</span>;<br>            resolvePromise(promise, <span class="hljs-variable language_">y</span>, resolve, reject);<br>          &#125;,<br>          <span class="hljs-comment">// å¦‚æœ rejectPromise ä»¥æ®å›  r ä¸ºå‚æ•°è¢«è°ƒç”¨ï¼Œåˆ™ä»¥æ®å›  r æ‹’ç» promise</span><br>          r =&gt; &#123;<br>            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;<br>            called = <span class="hljs-symbol">true</span>;<br>            reject(r);<br>          &#125;);<br>      &#125; <br>      ......   <br>å¤åˆ¶ä»£ç <br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆé—®é¢˜æ¥äº†</p>
<ul>
<li><strong>ä¸ºä»€ä¹ˆæˆ‘ä»¬ Promise A+ æµ‹è¯•å…¨éƒ¨é€šè¿‡çš„æ‰‹å†™ä»£ç ï¼Œæ‰§è¡Œç»“æœå´ä¸åŸç”Ÿ Promise ä¸åŒï¼Ÿ</strong></li>
<li><strong>åœ¨æˆ‘ä»¬æ‰‹å†™ä»£ç ä½¿ç”¨åˆ›å»ºä¸€æ¬¡å¾®ä»»åŠ¡çš„æ–¹å¼ï¼Œä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ</strong></li>
</ul>
<p>ES6 ä¸­çš„ Promise è™½ç„¶æ˜¯éµå¾ª Promise A+ è§„èŒƒå®ç°çš„ï¼Œä½†å®é™…ä¸Šä¹Ÿ Promise A+ ä¸Šåšäº†ä¸€äº›åŠŸèƒ½æ‰©å±•ï¼Œä¾‹å¦‚ï¼šPromise.allã€Promise.race ç­‰ï¼Œæ‰€ä»¥å³ä½¿éƒ½ç¬¦åˆ Promise A+ ï¼Œæ‰§è¡Œç»“æœä¹Ÿæ˜¯å¯èƒ½å­˜åœ¨å·®å¼‚çš„ã€‚æˆ‘ä»¬è¿™é‡Œæ›´éœ€è¦æ€è€ƒçš„æ˜¯ç¬¬äºŒä¸ªé—®é¢˜ï¼Œ<strong>ä¸è¿™ä¹ˆåšä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯åŠ ä¸€æ¬¡å¾®ä»»åŠ¡çš„å¿…è¦æ€§ã€‚</strong></p>
<p>æˆ‘å°è¯•è¿‡å¾ˆå¤šä¾‹å­ï¼Œéƒ½æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä¾‹è¯ï¼Œæˆ‘ä»¬æ‰‹å†™å®ç°çš„ Promise éƒ½å¾ˆå¥½çš„å®Œæˆå·¥ä½œï¼Œæ‹¿åˆ°äº†ç»“æœã€‚æˆ‘ä¸å¾—ä¸å»ç¿»çœ‹æ›´å¤šçš„ç›¸å…³æ–‡ç« ï¼Œæˆ‘å‘ç°æœ‰äº›äººä¼šä¸ºäº†è®©æ‰§è¡Œç»“æœä¸åŸç”Ÿç›¸åŒï¼Œå¼ºè¡Œå»å†å¤šåŠ ä¸€æ¬¡å¾®ä»»åŠ¡ï¼Œè¿™ç§åšæ³•æ˜¯å¾ˆç‰µå¼ºçš„ã€‚</p>
<p>æ¯•ç«Ÿå®ç° Promise çš„ç›®çš„æ˜¯ä¸ºäº†è§£å†³å¼‚æ­¥ç¼–ç¨‹çš„é—®é¢˜ï¼Œèƒ½å¤Ÿæ‹¿åˆ°æ­£ç¡®çš„ç»“æœæ‰æ˜¯æœ€é‡è¦çš„ï¼Œå¼ºè¡Œä¸ºäº†ç¬¦åˆé¢è¯•é¢˜çš„è¾“å‡ºé¡ºåºå»å¤šåŠ ä¸€æ¬¡å¾®ä»»åŠ¡ï¼Œåªèƒ½è®©æ‰‹å†™ä»£ç å˜çš„æ›´åŠ å¤æ‚ï¼Œä¸å¥½ç†è§£ã€‚</p>
<p>åœ¨ stackoverflow ä¸Šï¼Œæœ‰ä¸€ä¸ªç±»ä¼¼çš„é—®é¢˜ <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/58217603/what-is-the-difference-between-returned-promise">What is the difference between returned Promise?</a> å›ç­”ä¸­æœ‰ä¸€ä¸ªä¿¡æ¯å°±æ˜¯</p>
<blockquote>
<p><code>It only required the execution context stack contains only platform code.</code> ä¹Ÿå°±ç›¸å½“äºç­‰å¾… <code>execution context stack</code> æ¸…ç©ºã€‚</p>
</blockquote>
<p>è¿™ä¸ªåœ¨æ˜é‡‘ä¸­çš„ä¸€ç¯‡æ–‡ç«  <a target="_blank" rel="noopener" href="https://juejin.cn/post/6937076967283884040">æˆ‘ä»¥ä¸ºæˆ‘å¾ˆæ‡‚ Promiseï¼Œç›´åˆ°æˆ‘å¼€å§‹å®ç° Promise&#x2F;A + è§„èŒƒ</a> ä¹Ÿæœ‰ä¸€æ®µå…³äºè¿™é“é¢è¯•é¢˜çš„è®¨è®º</p>
<blockquote>
<p><code>return Promise.resolve(4)</code>ï¼ŒJS å¼•æ“ä¼šå®‰æ’ä¸€ä¸ª jobï¼ˆjob æ˜¯ ECMA ä¸­çš„æ¦‚å¿µï¼Œç­‰åŒäºå¾®ä»»åŠ¡çš„æ¦‚å¿µ)ï¼Œå…¶å›è°ƒç›®çš„æ˜¯è®©å…¶çŠ¶æ€å˜ä¸º fulfilledã€‚</p>
</blockquote>
<p>å®é™…ä¸Šæˆ‘ä»¬å·²ç»åœ¨ <code>static resolve</code> åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ MyPromsieï¼Œå¹¶è°ƒç”¨å…¶ then æ–¹æ³•ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¾®ä»»åŠ¡ã€‚</p>
<p>æ‰€ä»¥ï¼Œå°±ç›®å‰çš„ä¿¡æ¯æ¥è¯´ï¼Œä¸¤æ¬¡å¾®ä»»åŠ¡ä¾æ—§ä¸èƒ½è¯æ˜å…¶å¿…è¦æ€§ï¼Œç›®å‰çš„ Promise æ—¥å¸¸æ“ä½œï¼Œä¸€æ¬¡å¾®ä»»åŠ¡éƒ½æ˜¯å¯ä»¥æ»¡è¶³ã€‚</p>
<p>å¤§å®¶å¯¹äºè¿™ä¸ªé“é¢è¯•é¢˜æœ‰ä»€ä¹ˆæƒ³æ³•æˆ–è€…æ„è§ï¼Œèµ¶ç´§åœ¨ç•™è¨€åŒºå‘Šè¯‰æˆ‘å§ï¼Œä¸€èµ·æ¢è®¨ä¸€ä¸‹åˆ°åº•æ˜¯å¿…ç„¶è¿˜æ˜¯å·§åˆğŸ¤”</p>
<p><strong>é•¿æ–‡æ•´ç†ä¸æ˜“ï¼Œè®°å¾— ç‚¹èµ ğŸ‘ æ”¯æŒä¸€ä¸‹å“¦ ğŸ˜˜</strong></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Promise/" class="print-no-link">#Promise</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ä»ä¸€é“è®©æˆ‘å¤±çœ çš„Promiseé¢è¯•é¢˜å¼€å§‹ï¼Œæ·±å…¥åˆ†æPromiseå®ç°ç»†èŠ‚</div>
      <div>http://example.com/2021/03/31/ä»ä¸€é“è®©æˆ‘å¤±çœ çš„Promiseé¢è¯•é¢˜å¼€å§‹ï¼Œæ·±å…¥åˆ†æPromiseå®ç°ç»†èŠ‚/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>æ–‡å®‡å‡½</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2021å¹´3æœˆ31æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/06/01/%E4%BD%BF%E7%94%A8css%E7%9A%84GPU%E5%8A%A8%E7%94%BB%E4%BC%98%E5%8C%96/" title="ä½¿ç”¨cssçš„GPUåŠ¨ç”»ä¼˜åŒ–">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ä½¿ç”¨cssçš„GPUåŠ¨ç”»ä¼˜åŒ–</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/02/12/%E5%9C%A8%E5%A4%A7%E5%8E%82%E6%98%AF%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E7%BB%84%E7%BB%87npmscript%E7%9A%84/" title="åœ¨å¤§å‚æ˜¯å¦‚ä½•é«˜æ•ˆç»„ç»‡npmscriptçš„">
                        <span class="hidden-mobile">åœ¨å¤§å‚æ˜¯å¦‚ä½•é«˜æ•ˆç»„ç»‡npmscriptçš„</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
